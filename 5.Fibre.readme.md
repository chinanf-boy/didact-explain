## 5. Fibre-é€’å¢å¯¹æ¯”


> è¿™ä¸ªæ•…äº‹æ˜¯ç³»åˆ—`DIYğŸ‘‹è‡ªå·±-React`çš„ä¸€ä¸ªéƒ¨åˆ†, ä½†å› ä¸ºæˆ‘ä»¬è¦é‡å†™å¤§éƒ¨åˆ†æ—§ä»£ç çš„, æ— è®ºå¦‚ä½•, æˆ‘ä¼š tl;drå®ƒä¸€ä¸‹çš„: 


>TL;DR : åˆ°ç›®å‰ä¸ºæ­¢çš„ç³»åˆ—: æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªReactå…‹éš†ç®€åŒ–ç‰ˆæœ¬,æ¥äº†è§£Reactåœ¨åº•å±‚åšäº†ä»€ä¹ˆ. æˆ‘ä»¬ç§°ä¹‹ä¸º[`Didact`](./readme.md). ä¸ºäº†ç®€åŒ–ä»£ç , æˆ‘ä»¬åªå…³æ³¨-React-çš„ä¸»è¦å‡½æ•°. é¦–å…ˆæˆ‘,ä»¬ä»‹ç»å¦‚ä½•æ¸²æŸ“å…ƒç´ å¹¶ä½¿JSXå·¥ä½œ. æˆ‘ä»¬ç¼–å†™äº†å¯¹æ¯”ç®—æ³•æ¥é‡æ–°æ¸²æŸ“é‚£äº›ä»…åœ¨æ›´æ–°æœŸé—´æ›´æ”¹äº†çš„å†…å®¹. ç„¶åæˆ‘ä»¬æ·»åŠ äº†-`Component - class` å’Œ `setState()`. 


#### è¯´ä¸€è¯´ â¤ï¸ react didact

ç°åœ¨`React-16`å·²ç»ä¸å¤å­˜åœ¨, å¹¶ä¸”æœ‰äº†ä¸€ä¸ªæ–°çš„å†…éƒ¨æ¶æ„, éœ€è¦é‡å†™-React-çš„å¤§éƒ¨åˆ†ä»£ç . 

è¿™æ„å‘³ç€ä¸€äº›æœŸå¾…å·²ä¹…çš„å‡½æ•° - æ—§,çš„æ¶æ„å¾ˆéš¾å‘å±• - è¢«é€èµ°äº†ğŸ¶. 

è¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬åœ¨è¿™ä¸ªç³»åˆ—ä¸­ç¼–å†™çš„å¤§éƒ¨åˆ†ä»£ç ç°åœ¨éƒ½æ˜¯æ¯«æ— ä»·å€¼çš„. ä½†æ˜¯æ€æƒ³/é€»è¾‘å¯ä»¥ç•™ä¸‹ğŸ˜›

åœ¨æœ¬æ–‡ä¸­, æˆ‘ä»¬å°†é‡å†™-didact-ç³»åˆ—ä¸­çš„å¤§éƒ¨åˆ†ä»£ç , ä»¥éµå¾ª React-16 æ–°æ¶æ„. æˆ‘ä»¬å°†å°è¯•ä»Reactä»£ç åº“ä¸­ æ¨¡æ‹Ÿ å®ƒçš„ç»“æ„, å˜é‡å’Œå‡½æ•°åç§°. æˆ‘ä»¬å°†è·³è¿‡æˆ‘ä»¬ä¸éœ€è¦çš„-å…¬å…±API-: 

- `Didact.createElement()`

- `Didact.render()` ï¼ˆåªæœ‰DOMæ¸²æŸ“ï¼‰

- `Didact.Component`ï¼ˆä½¿ç”¨`setState()`ä½†æ²¡æœ‰`context`æˆ–è€…ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼‰

å¦‚æœä½ æƒ³è·³åˆ°å‰é¢çœ‹ä»£ç çš„è¿è¡Œæƒ…å†µ, ä½ å¯ä»¥å»

[æ›´æ–°çš„æ¼”ç¤º-codepen](https://codepen.io/pomber/pen/veVOdd)æˆ–è®¿é—®[->githubå­˜å‚¨åº“](https://github.com/hexacta/didact). 

ç°åœ¨, è®©æˆ‘è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦é‡å†™æ—§ä»£ç . 

---

## ç›®å½•

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [5.1 ä¸ºä»€ä¹ˆé€‰æ‹©Fiber](#51-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9fiber)
- [fibre ç†è§£æç¤º](#fibre-%E7%90%86%E8%A7%A3%E6%8F%90%E7%A4%BA)
- [5.2 è°ƒåº¦å¾®ä»»åŠ¡](#52-%E8%B0%83%E5%BA%A6%E5%BE%AE%E4%BB%BB%E5%8A%A1)
- [5.3 Fibre-æ•°æ®ç»“æ„](#53-fibre-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84)
  - [1. è¿™ `b`, `p`å’Œ`i` åœ¨ `Fibre` è¡¨ç¤º **host components**.](#1-%E8%BF%99-b-p%E5%92%8Ci-%E5%9C%A8-fibre-%E8%A1%A8%E7%A4%BA-host-components)
  - [2. ä¾‹å­ä¸­çš„ `<Foo>` åœ¨ `Fibre` ä¸­ è¡¨ç¤º **class component**.](#2-%E4%BE%8B%E5%AD%90%E4%B8%AD%E7%9A%84-foo-%E5%9C%A8-fibre-%E4%B8%AD-%E8%A1%A8%E7%A4%BA-class-component)
  - [3. `div `ä»£è¡¨`Fibre`çš„**host root**. å®ƒä¸ **host component** ç›¸ä¼¼,](#3-div-%E4%BB%A3%E8%A1%A8fibre%E7%9A%84host-root-%E5%AE%83%E4%B8%8E-host-component-%E7%9B%B8%E4%BC%BC)
  - [4. å¦ä¸€ä¸ªé‡è¦çš„å±æ€§æ˜¯`alternate`.](#4-%E5%8F%A6%E4%B8%80%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AFalternate)
- [5.4 Didactè°ƒç”¨å±‚æ¬¡ç»“æ„](#54-didact%E8%B0%83%E7%94%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84)
  - [5.4.1 æ—§ä»£ç ](#541-%E6%97%A7%E4%BB%A3%E7%A0%81)
  - [5.4.2 `render` å’Œ `scheduleUpdate`](#542-render-%E5%92%8C-scheduleupdate)
  - [5.4.3 `performWork` å’Œ `workLoop`](#543-performwork-%E5%92%8C-workloop)
  - [5.4.4 `resetNextUnitOfWork`](#544-resetnextunitofwork)
  - [5.4.5 `performUnitOfWork`](#545-performunitofwork)
  - [5.4.6 `beginWork`](#546-beginwork)
  - [5.4.7 `reconcileChildrenArray`](#547-reconcilechildrenarray)
  - [5.4.8 `cloneChildFibers`](#548-clonechildfibers)
  - [5.4.9 `completeWork`](#549-completework)
  - [5.4.10 `commitAllWork`](#5410-commitallwork)
- [5.5 æ­£åœ¨è¿è¡Œçš„Didact](#55-%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84didact)
- [5.6 ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ](#56-%E4%B8%8B%E4%B8%80%E6%AD%A5%E6%98%AF%E4%BB%80%E4%B9%88)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->


### 5.1 ä¸ºä»€ä¹ˆé€‰æ‹©Fiber


> è¿™ä¸ä¼šæä¾›`React-Fiber`çš„å®Œæ•´è¿‡ç¨‹. å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šä¿¡æ¯, è¯·æŸ¥çœ‹-[`react-fiberèµ„æºåˆ—è¡¨`](https://github.com/koba04/react-fiber-resources). 

å½“æµè§ˆå™¨çš„ä¸»çº¿ç¨‹é•¿æ—¶é—´å¿™äºè¿è¡Œæ—¶, å…³é”®çš„ç®€çŸ­ä»»åŠ¡å¿…é¡»ç­‰å¾…ä¸€æ®µä¸å¯æ¥å—çš„æ—¶é—´,æ‰èƒ½å®Œæˆ. 

ä¸ºäº†å±•ç¤ºè¿™ä¸ªé—®é¢˜, æˆ‘åšäº†ä¸€ä¸ª[å°æ¼”ç¤º](https://pomber.github.io/incremental-rendering-demo/react-sync.html). ä¸ºäº†ä¿æŒè¡Œæ˜Ÿçš„æ—‹è½¬, ä¸»çº¿ç¨‹éœ€è¦åœ¨æ¯16mså·¦å³å°±è¦è¿è¡Œä¸€æ¬¡. å¦‚æœä¸»çº¿ç¨‹è¢«å…¶ä»–ä¸œè¥¿é˜»å¡, è®©æˆ‘ä»¬å®šä¸ª200æ¯«ç§’, ä½ ä¼šæ³¨æ„åˆ°åŠ¨ç”»ä¸¢å¤±å¸§å’Œè¡Œæ˜Ÿå†»ç»“/å¡é¡¿, ç›´åˆ°ä¸»çº¿ç¨‹å†æ¬¡é‡Šæ”¾. 

> æ˜¯ä»€ä¹ˆè®©ä¸»çº¿ç¨‹å¦‚æ­¤ç¹å¿™, ä»¥è‡³äºæ— æ³•å°†ä¸€äº› ms, èŠ±è´¹åœ¨ä¿æŒ`åŠ¨ç”»å¹³æ»‘`å’Œ`UIå“åº”`ä¸Šå‘¢ï¼Ÿ

è®°ä½-[`å¯¹æ¯”ç®—æ³•ä»£ç `-3-å®ä¾‹-å¯¹æ¯”å’Œè™šæ‹Ÿdom](./readme.md#3-å®ä¾‹-å¯¹æ¯”å’Œè™šæ‹Ÿdom)ï¼Ÿ ä¸€æ—¦å¼€å§‹å¯¹æ¯”, å®ƒå°±ä¸ä¼šåœæ­¢. å¦‚æœä¸»çº¿ç¨‹éœ€è¦åšå…¶ä»–ä»»ä½•äº‹æƒ…, å®ƒå°†ä¸å¾—ä¸ç­‰å¾…. è€Œä¸”, **å› ä¸ºå¾ˆå¤§ç¨‹åº¦ä¸Šå®ƒå–å†³äºé€’å½’è°ƒç”¨, æ‰€ä»¥å¾ˆéš¾ä½¿å®ƒåœæ­¢,å†ç»§ç»­**. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç”¨ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„æ¥é‡å†™å®ƒ, è¿™å°†å…è®¸æˆ‘ä»¬ç”¨`å¾ªç¯`-æ›¿æ¢-`é€’å½’è°ƒç”¨`. 

###  fibre ç†è§£æç¤º

<details>

[å¦‚æœä½ æ˜¯æ–°æ‰‹,è¯·ç‚¹å‡»å¹¶è§‚å¯Ÿ æœ¬ğŸŒ°ä¸­ä¸¤ç§ä¸åŒ `jsbin-fibre`](http://jsbin.com/coyunux/2/edit?js,console)

- çœ‹äº†ä¸Šé¢è¿™ä¸ªğŸŒ°, ä½ éœ€è¦æ˜ç™½, `fibre` å¸¦æœ‰æ•°æ®æµåŠ¨ çš„è®¤çŸ¥

- ç„¶åä½ çœ‹ [`æ­¤èµ„æºåˆ—è¡¨`]((https://github.com/koba04/react-fiber-resources)) , è¿™æ˜¯ä¸ºäº†åŠ æ·±-å¯¹-react-fibre çš„è®¤çŸ¥, æˆ‘ä»¬éœ€è¦å…¶ä¸­çš„[demo-ğŸŒ°å­](https://koba04.github.io/react-fiber-resources/examples/)

>`è¯´å› react-fibre è¿™ä¸ªå¿µæƒ³ ` : å¸¦æœ‰æ•°æ®çš„ç‰¹æ€§ çš„ `-fibre-`ä¸­ è¢«è®°å½•äº†`-ä¼˜å…ˆçº§-`å±æ€§. 

å¯ä»¥çœ‹åˆ°[demo-ğŸŒ°å­](https://koba04.github.io/react-fiber-resources/examples/) å¸¦æœ‰å…± ä¸‰ä¸ªé€‰æ‹©æˆ–è¾“å…¥é¡¹ 

  1. `pleace input text`

  > æ²¡æœ‰å˜åŒ–çš„

  2. `Async mode` é»˜è®¤

  > ä½¿ç”¨äº†-[å®éªŒæ€§`react.unstable_deferredUpdates` ä¼šèµ‹äºˆæ­¤å…ƒç´ ä¸€ä¸ªä½çš„ä¼˜å…ˆçº§](https://sourcegraph.com/github.com/koba04/react-fiber-resources/-/blob/examples/components/App.js#L30)

  3. `sync mode`

  > ä¼šåˆ°åŒæ­¥, ä¹Ÿå°±æ˜¯æ²¡æœ‰å˜åŒ–

å¯ä»¥çœ‹åˆ° -`Async mode`- çš„å¡é¡¿, å› ä¸ºå®ƒè¿™ä¸ªç»„ä»¶å…ƒç´ è¢«åˆ†é…çš„ä¼˜å…ˆçº§ä½, è€Œ`sync mode`çš„ä¼˜å…ˆçº§æ¯” `Async mode` é«˜, `Async mode`è¦ä¸ºä¼˜å…ˆçº§é«˜çš„è®©é“. æ¯”å¦‚ä¼˜å…ˆçº§é«˜çš„åŠ¨ç”». 

> å½“ç„¶, `react-fibre` ä¸æ­¢åšäº†è¿™ä»¶äº‹:P

</details>


### 5.2 è°ƒåº¦å¾®ä»»åŠ¡


æˆ‘ä»¬éœ€è¦å°†å·¥ä½œ-åˆ†è§£ä¸ºæ›´å°çš„éƒ¨åˆ†, å¯ä»¥çŸ­æ—¶é—´è¿è¡Œè¿™äº›éƒ¨åˆ†, è®©ä¸»çº¿ç¨‹æ‰§è¡Œ`æ›´é«˜ä¼˜å…ˆçº§`çš„ä»»åŠ¡, å¹¶ä¸”å¦‚æœæœ‰-ä»»ä½•å¾…å¤„ç†çš„äº‹æƒ…-å†å›æ¥å®Œæˆå·¥ä½œ. 

æˆ‘ä»¬ä¼šåœ¨[requestIdleCallback()](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)å‡½æ•°çš„å¸®åŠ©ä¸‹,åšåˆ°è¿™ä¸€ç‚¹. å®ƒå°†ä¸‹ä¸€æ¬¡æµè§ˆå™¨ç©ºé—²æ—¶,è°ƒç”¨æˆ‘ä»¬çš„`preformWork`å›è°ƒå‡½æ•°, å¹¶åŠ å…¥ä¸€ä¸ª`deadline`å‚æ•°, ç”¨äºæè¿°æˆ‘ä»¬çš„ä»£ç å¯ç”¨æ—¶é—´: 

``` js
const ENOUGH_TIME = 1; // milliseconds

let workQueue = [];
let nextUnitOfWork = null; // å…¨å±€å˜é‡, é‚£ä¹ˆä¸€æ¬¡åªèƒ½èµ°ä¸€ä¸ªå›è°ƒ

function schedule(task) { // 1. åŠ 
  workQueue.push(task); // 2. å­˜å¥½äº†
  requestIdleCallback(performWork); // 3. ä¸‹ä¸€æ¬¡ç©ºé—²è¿è¡Œ, performWork å‡½æ•°
}

function performWork(deadline) { // ç©ºé—²æœºä¼šæ¥äº†
  if (!nextUnitOfWork) {
    nextUnitOfWork = workQueue.shift(); // 4. æ‹¿å‡ºæ¥,
  }

// ä¸‹ä¸€å›è°ƒ ä¸ çœ‹çœ‹æœ‰æ²¡æœ‰ è¶³å¤Ÿçš„æ—¶é—´ å†èµ°ä¸€è¶Ÿ 
  while (nextUnitOfWork && deadline.timeRemaining() > ENOUGH_TIME) {
    // 5. DO something
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
  }

  if (nextUnitOfWork || workQueue.length > 0) {
     // 6. å¦‚æœè¿˜æ²¡æœ‰æå®š, é‚£ä¹ˆ å†ç­‰ç©ºé—²å’¯
    requestIdleCallback(performWork);
  }
}
```

çœŸæ­£çš„å·¥ä½œå‘ç”Ÿåœ¨`performUnitOfWork`å‡½æ•°çš„å†…éƒ¨. æˆ‘ä»¬éœ€è¦åœ¨é‚£é‡Œç¼–å†™æˆ‘ä»¬çš„`å¯¹æ¯”-{reconciliation}ç®—æ³•`ä»£ç . è¯¥å‡½æ•°åº”è¯¥è¿è¡Œä¸€éƒ¨åˆ†å·¥ä½œ, ç„¶å-`è¿”å›-{return}`-ä¸‹ä¸€æ¬¡æ¢å¤å·¥ä½œéœ€è¦çš„æ‰€æœ‰ä¿¡æ¯. 

ä¸ºäº†è·Ÿè¸ªè¿™äº›å·¥ä½œ, æˆ‘ä»¬å°†ä½¿ç”¨`Fibre`. 

### 5.3 Fibre-æ•°æ®ç»“æ„


æˆ‘ä»¬å°†ä¸ºæ¯ä¸ªæƒ³è¦æ¸²æŸ“çš„ç»„ä»¶åˆ›å»ºä¸€ä¸ª`Fibre`. 

- `nextUnitOfWork`å°†æ˜¯å¯¹ä¸‹ä¸€ä¸ªå·¥ä½œ`Fibre`çš„å‚è€ƒ. 
- `performUnitOfWork`æ‹¿åˆ°`Fibre`,å¹¶åœ¨å…¶ä¸Šå·¥ä½œ, å¹¶è¿”å›ä¸€ä¸ª`æ–°çš„Fibre`ç”¨äºä¸‹ä¸€æ¬¡ - ç›´åˆ°æ‰€æœ‰å·¥ä½œå®Œæˆ. 

å®¹è®¸ä¸‹, æˆ‘ä¼šç¨åè¯¦ç»†è§£é‡Šè¿™ä¸€ç‚¹. 

`Fibre`æ˜¯æ€æ ·çš„ ï¼Ÿ

``` js
let fiber = {
  tag: HOST_COMPONENT,
  type: "div",
  parent: parentFiber,
  child: childFiber,
  sibling: null,
  alternate: currentFiber,
  stateNode: document.createElement("div"),
  props: { children: [], className: "foo"},
  partialState: null,
  effectTag: PLACEMENT,
  effects: []
};
```
è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„æ—§JavaScriptå¯¹è±¡. 

æˆ‘ä»¬å°†ä½¿ç”¨`parent`, `child`å’Œ`sibling`-å±æ€§-æ‰“é€ çš„`Fibre`æ ‘æ¥æè¿°ç»„ä»¶çš„æ ‘. 

è¿™`stateNode`å°†æ˜¯å¯¹`Component`å®ä¾‹çš„å¼•ç”¨. å®ƒå¯ä»¥æ˜¯`DOMå…ƒç´ `, ä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·å®šä¹‰çš„`Component-class`çš„å®ä¾‹. 

ä¾‹å¦‚: 

![fibre-1](./imgs/fibre-1.png)

åœ¨è¿™ä¸ªä¾‹å­ä¸­, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°†æ”¯æŒçš„ä¸‰ç§ä¸åŒç±»å‹çš„ç»„ä»¶: 

#### 1. è¿™ `b`, `p`å’Œ`i` åœ¨ `Fibre` è¡¨ç¤º **host components**. 

æˆ‘ä»¬å°†ç”¨ 
``` js 
tag: HOST_COMPONENT,
```
æ¥è¯†åˆ«å®ƒä»¬. 

- `fibre.type`æ˜¯htmlå…ƒç´ çš„æ ‡ç­¾:`string`.

- `fibre.props`æ˜¯å…ƒç´ çš„-å±æ€§-å’Œ-äº‹ä»¶ç›‘å¬å™¨-. 

#### 2. ä¾‹å­ä¸­çš„ `<Foo>` åœ¨ `Fibre` ä¸­ è¡¨ç¤º **class component**. 

å®ƒçš„`tag`æ˜¯`CLASS_COMPONENT`å’Œ`type`æ¥è‡ª ç”¨æˆ·å®šä¹‰çš„`Didact.Component`. 

#### 3. `div `ä»£è¡¨`Fibre`çš„**host root**. å®ƒä¸ **host component** ç›¸ä¼¼, 

å› ä¸ºå®ƒæœ‰DOMå…ƒç´ å¯ä»¥ä½œä¸º`stateNode`, ä½†ä½œä¸ºæ ‘çš„æ ¹, å®ƒä¼šå¾—åˆ°ç‰¹æ®Šå¤„ç†. `Fibre.tag`ä¼šæ˜¯**HOST_ROOT**. è¯·æ³¨æ„, `Fibre.stateNode`æ˜¯ä¼ é€’ç»™`Didact.render()`çš„DOMèŠ‚ç‚¹. 

#### 4. å¦ä¸€ä¸ªé‡è¦çš„å±æ€§æ˜¯`alternate`. 

æˆ‘ä»¬éœ€è¦å®ƒ, å› ä¸ºå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¼šæœ‰ä¸¤æ£µ`Fibre`æ ‘. 

- ä¸€æ£µæ ‘å°†å¯¹åº”äºæˆ‘ä»¬å·²ç»å‘ˆç°ç»™-`html-DOM`-çš„ä¸œè¥¿, æˆ‘ä»¬å°†å®ƒç§°ä¸ºå½“å‰æ ‘æˆ–æ—§æ ‘. 

- å¦ä¸€æ£µæ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºæ–°æ›´æ–°ï¼ˆè°ƒç”¨`setState()`æˆ– `Didact.render()` æ—¶æ„å»ºçš„æ ‘, æˆ‘ä»¬å°†æ­¤æ ‘ç§°ä¸ºæ­£åœ¨è¿›è¡Œä¸­çš„æ ‘, ç®€ç§°ä¸º`å·¥ä½œæ ‘`

å·¥ä½œæ ‘ä¸ä¼šä¸æ—§æ ‘å…±äº«ä»»ä½•`Fibre`. ä¸€æ—¦æˆ‘ä»¬å®Œæˆ-`å·¥ä½œæ ‘`-çš„å·¥ä½œå»ºè®¾,å¹¶å–å¾—æ‰€éœ€çš„ DOMå˜åŒ–, `å·¥ä½œæ ‘`ä¼šæˆä¸ºæ—§æ ‘. 

å› æ­¤, æˆ‘ä»¬ä½¿ç”¨`alternate`é“¾æ¥ æ­£åœ¨è¿›è¡Œä¸­çš„`Fiber`ä¸ ç›¸åº”æ—§æ ‘çš„`Fiber`. `Fibre`å’Œå®ƒçš„`alternate`åˆ†äº«ç›¸åŒ`tag`, `type`ä¸`stateNode`. æœ‰æ—¶,å½“æˆ‘ä»¬æ¸²æŸ“æ–°çš„ä¸œè¥¿æ—¶,`Fibre`ä¸ä¼šæœ‰`alternate`. 

æœ€å, æˆ‘ä»¬æœ‰`effects`åˆ—è¡¨å’Œ`effectTag`. å½“æˆ‘ä»¬å‘ç°`å·¥ä½œæ ‘`çš„`Fibre`æœ‰éœ€è¦æ”¹å˜çš„DOM, æˆ‘ä»¬å°†è®¾ç½®`effectTag`ä¸º`PLACEMENT`, `UPDATE`æˆ–`DELETION`. ä¸ºäº†æ›´å®¹æ˜“å°†æ‰€æœ‰DOMå˜åŒ–ä¸€èµ·æäº¤, æˆ‘ä»¬ä¿ç•™äº†æ‰€æœ‰`Fibre`ï¼ˆæ¥è‡ª`Fibre`å­æ ‘ï¼‰çš„`effectTag`é¡¹åˆ°åˆ—è¡¨`effects`. 

> è¿™å¯èƒ½æ˜¯ä¸€æ¬¡å¤ªå¤šçš„ä¿¡æ¯, å¦‚æœä½ æ²¡æœ‰è·Ÿä¸Š, ä¸è¦æ‹…å¿ƒ, æˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°`Fibre`æ ‘çš„è¿è¡Œ. 

### 5.4 Didactè°ƒç”¨å±‚æ¬¡ç»“æ„

è¦äº†è§£æˆ‘ä»¬è¦ç¼–å†™çš„ä»£ç çš„æµç¨‹, è¯·æŸ¥çœ‹æ­¤å›¾è¡¨: 

![5-pic](./imgs/5-pic.png)

æˆ‘ä»¬å°†ä»`renderï¼ˆï¼‰`å’Œ`setStateï¼ˆï¼‰`å¼€å§‹, å¹¶éµå¾ªä»¥`commitAllWorkï¼ˆï¼‰`ç»“å°¾çš„æµç¨‹ã€‚

#### 5.4.1 æ—§ä»£ç 

æˆ‘å‘Šè¯‰è¿‡ä½ , æˆ‘ä»¬å°†é‡å†™å¤§éƒ¨åˆ†ä»£ç , ä½†æˆ‘ä»¬é¦–å…ˆå›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä¸ä¼šhé‡å†™çš„ä»£ç . 

- åœ¨[`å…ƒç´ åˆ›å»ºå’ŒJSX`](./2.JSX.md)ä¸­, æˆ‘ä»¬ç¼–å†™äº†ç”¨äºç¼–è¯‘JSXçš„å‡½æ•°ä»£ç `createElement()`. æˆ‘ä»¬ä¸éœ€è¦æ”¹å˜å®ƒ, æˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨ç›¸åŒçš„å…ƒç´ . å¦‚æœä½ ä¸çŸ¥é“å…ƒç´ ä¸­, å…³äº`type`, `props` å’Œ `children`è¿™äº›, è¯·æŸ¥çœ‹æ—§å¸–å­. 

- åœ¨[å®ä¾‹, å¯¹æ¯”ç®—æ³•å’Œè™šæ‹ŸDOM](./3.Virtual.md)ä¸­, æˆ‘ä»¬ç¼–å†™äº†ç”¨äºæ›´æ–°èŠ‚ç‚¹DOMå±æ€§çš„`updateDomProperties()`å‡½æ•°. æˆ‘è¿˜æ‰©å±•äº†ç”¨äºåˆ›å»ºDOMå…ƒç´ çš„å‡½æ•°`createDomElement()`. ä½ å¯ä»¥åœ¨è¿™ä¸ª[dom-utils.js çš„ gist](https://gist.github.com/pomber/c63bd22dbfa6c4af86ba2cae0a863064)ä¸­çœ‹åˆ°è¿™ä¸¤ä¸ªå‡½æ•°. 

<details>

<summary> gist å†…å®¹åœ¨è¿™é‡Œ ğŸ‘Œ</summary>

``` js
const isEvent = name => name.startsWith("on");
const isAttribute = name =>
  !isEvent(name) && name != "children" && name != "style";
const isNew = (prev, next) => key => prev[key] !== next[key];
const isGone = (prev, next) => key => !(key in next);

function updateDomProperties(dom, prevProps, nextProps) {
  // Remove event listeners
  Object.keys(prevProps)
    .filter(isEvent)
    .filter(key => !(key in nextProps) || isNew(prevProps, nextProps)(key))
    .forEach(name => {
      const eventType = name.toLowerCase().substring(2);
      dom.removeEventListener(eventType, prevProps[name]);
    });

  // Remove attributes
  Object.keys(prevProps)
    .filter(isAttribute)
    .filter(isGone(prevProps, nextProps))
    .forEach(name => {
      dom[name] = null;
    });

  // Set attributes
  Object.keys(nextProps)
    .filter(isAttribute)
    .filter(isNew(prevProps, nextProps))
    .forEach(name => {
      dom[name] = nextProps[name];
    });

  // Set style
  prevProps.style = prevProps.style || {};
  nextProps.style = nextProps.style || {};
  Object.keys(nextProps.style)
    .filter(isNew(prevProps.style, nextProps.style))
    .forEach(key => {
      dom.style[key] = nextProps.style[key];
    });
  Object.keys(prevProps.style)
    .filter(isGone(prevProps.style, nextProps.style))
    .forEach(key => {
      dom.style[key] = "";
    });

  // Add event listeners
  Object.keys(nextProps)
    .filter(isEvent)
    .filter(isNew(prevProps, nextProps))
    .forEach(name => {
      const eventType = name.toLowerCase().substring(2);
      dom.addEventListener(eventType, nextProps[name]);
    });
}

function createDomElement(fiber) {
  const isTextElement = fiber.type === TEXT_ELEMENT;
  const dom = isTextElement
    ? document.createTextNode("")
    : document.createElement(fiber.type);
  updateDomProperties(dom, [], fiber.props);
  return dom;
}
```
</details>

</br>

- åœ¨[ç»„ä»¶å’ŒçŠ¶æ€](./4.Components-and-State.md)ä¸­, æˆ‘ä»¬ç¼–å†™äº†Component-åŸºç±». è®©æˆ‘ä»¬æ”¹å˜å®ƒ,ä»¥ä¾¿`setState()`å¯ä»¥è°ƒç”¨`scheduleUpdate()`,å’Œ`createInstance()`æ¥ä¿å­˜å®ä¾‹ä¸­`Fibre`çš„å¼•ç”¨: 

``` js
class Component {
  constructor(props) {
    this.props = props || {};
    this.state = this.state || {};
  }

  setState(partialState) {
    scheduleUpdate(this, partialState); // <==
  }
}

function createInstance(fiber) {
  const instance = new fiber.type(fiber.props);
  instance.__fiber = fiber;
  return instance;
}
```


ä»è¿™æ®µä»£ç å¼€å§‹, è®©æˆ‘ä»¬ä»å¤´å¼€å§‹é‡å†™å…¶ä½™éƒ¨åˆ†



#### 5.4.2 `render` å’Œ `scheduleUpdate`

![5-pic1](./imgs/5-pic1.png)


é™¤äº†`Component` class å’Œ `createElement()` ä¹‹å¤–, æˆ‘ä»¬è¿˜ä¼šæœ‰ä¸¤ä¸ªå…¬å…±å‡½æ•°: `render()` å’Œ `setState()`, æˆ‘ä»¬çœ‹åˆ°è¿™`setState()`åªæ˜¯è°ƒç”¨`scheduleUpdate()`. 

`render()`å’Œ`scheduleUpdate()`æ˜¯ç›¸ä¼¼çš„, ä»–ä»¬ä¼šæ”¶åˆ°ä¸€ä¸ªæ–°çš„æ›´æ–°å¹¶å¯¹å…¶è¿›è¡Œæ’é˜Ÿ: 

``` js
// Fiber tags
const HOST_COMPONENT = "host";
const CLASS_COMPONENT = "class";
const HOST_ROOT = "root";

// Global state
const updateQueue = [];
let nextUnitOfWork = null;
let pendingCommit = null;

function render(elements, containerDom) {
  updateQueue.push({ // ç”¨ä½œä¸€ä¸ªé˜Ÿåˆ—, å…ˆè¿›å…ˆå‡º
    from: HOST_ROOT,
    dom: containerDom,
    newProps: { children: elements }
  });
  requestIdleCallback(performWork); // ä¸‹ä¸€ä¸ªæµè§ˆå™¨ç©ºé—²æ—¶
}

function scheduleUpdate(instance, partialState) { // æä¾›ç»™ setState ä½¿ç”¨
  updateQueue.push({
    from: CLASS_COMPONENT,
    instance: instance,
    partialState: partialState
  });
  requestIdleCallback(performWork);
}
```

æˆ‘ä»¬å°†ä½¿ç”¨è¯¥`updateQueue`æ•°ç»„æ¥è·Ÿè¸ªå¾…å¤„ç†çš„æ›´æ–°. æ¯æ¬¡è¿è¡Œ`render()`æˆ–`scheduleUpdate()`ä¼šæ¨é€ä¸€ä¸ªæ–°çš„æ›´æ–°åˆ°`updateQueue`. æ¯ä¸ªæ›´æ–°ä¸­çš„æ›´æ–°ä¿¡æ¯éƒ½ä¸åŒ, ç­‰ä¼šä½ ä¼šçœ‹åˆ°,æˆ‘ä»¬åœ¨ä¹‹åçš„`resetNextUnitOfWork()`å‡½æ•°ä¸­ä½¿ç”¨å®ƒ. 

å°†æ›´æ–°æ¨é€åˆ°é˜Ÿåˆ—å, æˆ‘ä»¬è§¦å‘å»¶è¿Ÿå›è°ƒ`performWork()`å‡½æ•°


#### 5.4.3 `performWork` å’Œ `workLoop`

![5-pic2](./imgs/5-pic2.png)


``` js
const ENOUGH_TIME = 1; // milliseconds

function performWork(deadline) {
  workLoop(deadline);
  if (nextUnitOfWork || updateQueue.length > 0) {
      // æ˜¯å¦ æœ‰ å¾…å®¡æ‰¹å·¥ä½œ
    requestIdleCallback(performWork);
  }
}

function workLoop(deadline) {
  if (!nextUnitOfWork) {
    resetNextUnitOfWork();
  }
  while (nextUnitOfWork && deadline.timeRemaining() > ENOUGH_TIME) {
      // å…³æ³¨æ—¶é—´ æ˜¯å¦è¶³å¤Ÿ è¿è¡Œå¦ä¸€ä¸ªå·¥ä½œå•å…ƒ
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
  }
  if (pendingCommit) {
    commitAllWork(pendingCommit);
  }
}
```

> æ­£å¦‚æˆ‘ä»¬åœ¨ [5.2 è°ƒåº¦å¾®ä»»åŠ¡](#52-%E8%B0%83%E5%BA%A6%E5%BE%AE%E4%BB%BB%E5%8A%A1) ä¸­ äº†è§£åˆ°çš„å¾ªç¯å·¥ä½œæµç¨‹, åªæ˜¯å…·ä½“åˆ†æ”¯èµ·äº†å¯¹åº”çš„åç§°

æ˜¯ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨`performUnitOfWork()`æ—¶,çœ‹åˆ°çš„æ¨¡å¼. 

`requestIdleCallback()`æä¾›`æˆªæ­¢æ—¥æœŸ-{deadline}`ä½œä¸ºç›®æ ‡å‡½æ•°çš„å‚æ•°è°ƒç”¨. `performWork()`å°†`deadline`ä¼ ç»™å®ƒçš„`workLoop()`. ç„¶å`workLoop()`è¿è¡Œè¿”å›, `performWork()`æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¾…å®¡æ‰¹å·¥ä½œ. å¦‚æœæœ‰çš„è¯, å®ƒä¼šä¸ºå®ƒè‡ªå·±å®‰æ’ä¸€ä¸ªæ–°çš„`requestIdleCallback(performWork)`. 

`workLoop()`æ˜¯å…³æ³¨æ—¶é—´çš„å‡½æ•°. å¦‚æœ`deadline`æ—¶é—´å¤ªå°‘, å®ƒä¼šåœæ­¢å·¥ä½œå¾ªç¯,å¹¶ä¿æŒä¸‹ä¸€æ¬¡`nextUnitOfWork`æ›´æ–°éœ€è¦çš„`Fibre`çŠ¶æ€, ä»¥ä¾¿ä¸‹æ¬¡æ¢å¤.

>æˆ‘ä»¬ä½¿ç”¨`ENOUGH_TIME`ï¼ˆ1mså¸¸æ•°, ä¸Reactç›¸åŒï¼‰æ¥æ£€æŸ¥`deadline.timeRemaining()`,æ˜¯å¦æœ‰è¶³å¤Ÿè¿è¡Œå¦ä¸€ä¸ªå·¥ä½œå•å…ƒçš„æ—¶é—´. å¦‚æœ`performUnitOfWork()`è¶…è¿‡è¿™ä¸€æ—¶é—´, æˆ‘ä»¬å°†ç•™å¾…ä¸‹æ¬¡ç»§ç»­. `deadline`åªæ˜¯æ¥è‡ªæµè§ˆå™¨çš„å»ºè®®, æ‰€ä»¥å°†å…¶è¶…è¿‡å‡ æ¯«ç§’å¹¶ä¸æ˜¯é‚£ä¹ˆç³Ÿç³•.

`performUnitOfWork()`å°†ç”¨æ­£åœ¨è¿›è¡Œçš„æ›´æ–°,å’Œæ‰¾å‡ºæˆ‘ä»¬éœ€è¦å¯¹-DOM-åº”ç”¨å“ªäº›æ›´æ”¹æ¥æ„å»º`å·¥ä½œæ ‘`. **è¿™å°†é€æ­¥å®Œæˆ, æ¯æ¬¡ä¸€æ®µ`Fibre`æ•°æ®**. 

å½“`performUnitOfWork()`å®Œæˆå½“å‰æ›´æ–°çš„æ‰€æœ‰å·¥ä½œæ—¶, å®ƒå°†`è¿”å›null`å’Œå°†åœ¨DOMä¸­å¾…å¤„ç†çš„æ›´æ”¹ç•™ç»™`pendingCommit`. æœ€å, `commitAllWork()`è·å–æ¥è‡ª`pendingCommit`çš„`effects`, å’Œå˜æ›´DOM. 

è¯·æ³¨æ„, `commitAllWork()`åœ¨å¾ªç¯ä¹‹å¤–è°ƒç”¨. `performUnitOfWork()`å®Œæˆçš„å·¥ä½œå¹¶ä¸ä¼šæ”¹å˜DOM, å› æ­¤å¯ä»¥å°†å…¶åˆ†å¼€. 

å¦ä¸€æ–¹é¢, `commitAllWork()`å°†æ”¹å˜DOM, å®ƒåº”è¯¥ä¸€æ¬¡å®Œæˆ, ä»¥é¿å…ä¸ä¸€è‡´çš„UI. 

> æˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°ç¬¬ä¸€ä¸ª`nextUnitOfWork`æ¥è‡ªå“ªé‡Œ

#### 5.4.4 `resetNextUnitOfWork`

![5-pic3](./imgs/5-pic3.png)


> `resetNextUnitOfWork()` è¿è¡Œåœ¨ä¸Šä¸€å°èŠ‚çš„`workLoop`å‡½æ•°ä¸­

`resetNextUnitOfWork()`è·å–ä¸€æ¬¡æ›´æ–°,å¹¶å°†å…¶è½¬æ¢ä¸ºç¬¬ä¸€ä¸ª`nextUnitOfWork`: 

``` js
function resetNextUnitOfWork() {
  const update = updateQueue.shift();
  if (!update) {
    return;
  }

  // Copy the setState parameter from the update payload to the corresponding fiber
  if (update.partialState) {
    update.instance.__fiber.partialState = update.partialState;
  }

  const root =
    update.from == HOST_ROOT
      ? update.dom._rootContainerFiber
      : getRoot(update.instance.__fiber);

  nextUnitOfWork = {
    tag: HOST_ROOT,
    stateNode: update.dom || root.stateNode, // ä¸¤ç§æƒ…å†µ
    props: update.newProps || root.props,
    alternate: root
  };
}

function getRoot(fiber) {
  let node = fiber;
  while (node.parent) {
    node = node.parent;
  }
  return node;
}
```

- `resetNextUnitOfWork()` é¦–å…ˆä»é˜Ÿåˆ—ä¸­æå–ç¬¬ä¸€ä¸ªæ›´æ–°. 

- å¦‚æœæœ‰æ›´æ–°, `partialState`æˆ‘ä»¬å°†å®ƒå­˜å‚¨åœ¨å±äºç»„ä»¶å®ä¾‹çš„`Fibre`ä¸Š, ä»¥ä¾¿ç¨ååœ¨è°ƒç”¨ç»„ä»¶`render()`æ—¶ä½¿ç”¨å®ƒ. 

- ç„¶åæˆ‘ä»¬æ‰¾åˆ°æ—§`Fibre`æ ‘çš„æ ¹. å¦‚æœæ›´æ–°æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨`render()`æ—¶, æˆ‘ä»¬ä¸ä¼šæœ‰ä¸€ä¸ªæ ¹`Fibre`,æ‰€ä»¥`root == null`. å¦‚æœå®ƒæ¥è‡ªåç»­çš„`render()`è°ƒç”¨, æˆ‘ä»¬å¯ä»¥åœ¨DOMèŠ‚ç‚¹çš„`_rootContainerFiber`å±æ€§ä¸Šæ‰¾åˆ°æ ¹. å¦‚æœæ›´æ–°æ¥è‡ªä¸€æ¬¡`setState()`, æˆ‘ä»¬éœ€è¦ä»å®ä¾‹`Fibre`å¾€ä¸Šæ‰¾, ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ª`Fibre`æ˜¯æ²¡æœ‰-`parent`çš„. 

- ç„¶åæˆ‘ä»¬è®©`nextUnitOfWork`é‡æ–°è·å¾—äº†ä¸€ä¸ªæ–°çš„`Fibre`.**è¿™`Fibre`æ˜¯ä¸€ä¸ªæ–°çš„å·¥ä½œæ ‘çš„æ ¹**. 

å¦‚æœæˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ª _æ—§_  çš„æ ¹, é‚£ä¹ˆè¿™ä¸ª**DOMèŠ‚ç‚¹**`stateNode`å°±ä¼šåœ¨`render()`è°ƒç”¨ä¸­,ä½œä¸ºå‚æ•°è¢«æ¥æ”¶. è¿™`props`å°†æ˜¯æ¥è‡ªæ›´æ–°çš„`newProps`: å¯¹è±¡ä¸­çš„ä¸€ä¸ª`children`å±æ€§å…·æœ‰å…ƒç´ ,`children`æ˜¯`render()`çš„å¦ä¸€ä¸ªå‚æ•°. è¯¥`alternate == null`. 

å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª _æ—§_ çš„æ ¹, é‚£ä¹ˆ`stateNode`å°†æ˜¯å‰ä¸€ä¸ªæ ¹çš„**DOMèŠ‚ç‚¹**. è¯¥`props`å¦‚æœä¸æ˜¯null,åˆä¼šæ˜¯`newProps`, å¦åˆ™æˆ‘ä»¬å°†ä» _æ—§_ æ ¹å¤åˆ¶`props`. é‚£è¿™`alternate`å°†æ˜¯ _æ—§_ æ ¹. 


æˆ‘ä»¬ç°åœ¨æ‹¥æœ‰`æ­£åœ¨è¿›è¡Œä¸­çš„æ ‘`çš„æ ¹, è®©æˆ‘ä»¬å¼€å§‹æ„å»ºå‰©ä½™çš„æ ‘. 


#### 5.4.5 `performUnitOfWork`

![5-pic4](./imgs/5-pic4.png)


``` js

function performUnitOfWork(wipFiber) {
  beginWork(wipFiber);
  if (wipFiber.child) { // å·¥ä½œæ²¡æœ‰å®Œæˆ, è¿”å›ä¸‹ä¸€æ¬¡æ›´æ–°çš„çŠ¶æ€
    return wipFiber.child;
  }

  // No child, we call completeWork until we find a sibling
  let uow = wipFiber;
  while (uow) {
    completeWork(uow);
    if (uow.sibling) {
      // Sibling è¿”å›, å†æ¬¡å˜ä¸º wipFiber, è¢« beginWork è°ƒç”¨
      return uow.sibling;
    }
    uow = uow.parent;
  }
}
```

`performUnitOfWork()` ä¼šè¿è¡Œ è¿›è¡Œä¸­çš„å·¥ä½œæ ‘. 

- æˆ‘ä»¬ç§°ä¹‹ä¸º`beginWork()`â€Š- åˆ›é€ ä¸€ä¸ªæ–°çš„`Fibre`å­©å­ - ç„¶åè®©ç¬¬ä¸€ä¸ªå­©å­è¿”å›,æˆä¸º`nextUnitOfWork`. 

- å¦‚æœæ²¡æœ‰ä»»ä½•çš„å­©å­, æˆ‘ä»¬æ¥ç€`completeWork()`,å¹¶è¿”å›`sibling`ä½œä¸º`nextUnitOfWork`. 

- å¦‚æœæ²¡æœ‰`sibling`, æˆ‘ä»¬ä¼šç»§ç»­å¾€`parent`ä¸­æ‰¾, `completeWork()`ç›´åˆ°æˆ‘ä»¬æ‰¾åˆ°`sibling`ï¼ˆå°†æˆä¸º`nextUnitOfWork`ï¼‰æˆ–åˆ°è¾¾æ ¹éƒ¨. 

`performUnitOfWork()`å¤šæ¬¡è°ƒç”¨,ä¼šæ²¿ç€ å·¥ä½œæ ‘ å‘ä¸‹, åˆ›å»ºæ¯æ ¹`Fibre`çš„ç¬¬ä¸€ä¸ª`child`çš„`children`, è‹¥æ‰¾åˆ°æ²¡æœ‰å­©å­çš„`Fibre`. å°±å‘'å³'å’Œå‘'ä¸Š'æ‰¾, å°±å¥½åƒæœ‰å…„å¼Ÿå§å¦¹,çˆ¶æ¯,æ•´ä¸ªå®¶æ—å›¾ä¼¼çš„. ï¼ˆä¸ºäº†æ›´åŠ ç”ŸåŠ¨, å¯ä»¥å°è¯•åœ¨[fiber-è°ƒè¯•å™¨](http://fiber-debugger.surge.sh/)ä¸Šæ¸²æŸ“ä¸€äº›ç»„ä»¶ï¼‰


#### 5.4.6 `beginWork`

![5-pic4](./imgs/5-pic5.png)



``` js
function beginWork(wipFiber) {
  if (wipFiber.tag == CLASS_COMPONENT) {
    updateClassComponent(wipFiber);
  } else {
    updateHostComponent(wipFiber);
  }
}

function updateHostComponent(wipFiber) {
  if (!wipFiber.stateNode) {
    wipFiber.stateNode = createDomElement(wipFiber);
  }
  const newChildElements = wipFiber.props.children;
  reconcileChildrenArray(wipFiber, newChildElements);
}

function updateClassComponent(wipFiber) {
  let instance = wipFiber.stateNode;
  if (instance == null) {
    // è°ƒç”¨ç±»åˆå§‹åŒ–
    instance = wipFiber.stateNode = createInstance(wipFiber);
  } else if (wipFiber.props == instance.props && !wipFiber.partialState) {
    // ä¸éœ€è¦æ›´æ–°,æœ€å å¤åˆ¶ å­©å­
    cloneChildFibers(wipFiber);
    return;
  }

  instance.props = wipFiber.props;
  instance.state = Object.assign({}, instance.state, wipFiber.partialState);
  wipFiber.partialState = null;

  const newChildElements = wipFiber.stateNode.render();
  reconcileChildrenArray(wipFiber, newChildElements);
}
```

`beginWork()` åšä¸¤ä»¶äº‹: 

- åˆ›é€ `stateNode`,å¦‚æœæˆ‘ä»¬æ²¡æœ‰
- è·å–ç»„ä»¶å­é¡¹å¹¶å°†å®ƒä»¬ä¼ é€’ç»™ `reconcileChildrenArray()`

å› ä¸ºä¸¤è€…éƒ½å–å†³äºæˆ‘ä»¬å¤„ç†çš„ç»„ä»¶çš„ç±»å‹, æ‰€ä»¥æˆ‘ä»¬å°†å®ƒåˆ†æˆä¸¤éƒ¨åˆ†: `updateHostComponent()`å’Œ`updateClassComponent()`. 

- `updateHostComponent()`å¤„ç† _ä¸»æœºç»„ä»¶_ ä»¥åŠ _æ ¹ç»„ä»¶_. å¦‚æœéœ€è¦çš„è¯, å®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹ï¼ˆåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹, æ²¡æœ‰å­èŠ‚ç‚¹, å¹¶ä¸”ä¸ä¼šå°†å…¶é™„åŠ åˆ°DOMï¼‰. **ç„¶åå®ƒé€šè¿‡è°ƒç”¨`reconcileChildrenArray()`å‡½æ•°, ä½¿ç”¨æ¥è‡ª`Fibre`ä¸­`props`å±æ€§çš„å­å…ƒç´ **. 

- `updateClassComponent()`å¤„ç†ç±»ç»„ä»¶å®ä¾‹. å¦‚æœéœ€è¦çš„è¯, å®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹,é€šè¿‡è°ƒç”¨`createInstance`å‡½æ•°. å®ƒæ›´æ–°å®ä¾‹çš„`props`, `state`,å› æ­¤å®ƒçš„`render()`å‡½æ•°å¯ä»¥è·å–æ–°çš„å­©å­. 

- `updateClassComponent()`ä¹ŸéªŒè¯è°ƒç”¨`render()`æ˜¯å¦æœ‰æ„ä¹‰. è¿™æ˜¯ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„`shouldComponentUpdate()`. å¦‚æœçœ‹èµ·æ¥æˆ‘ä»¬ä¸éœ€è¦é‡æ–°æ¸²æŸ“, é‚£ä¹ˆæˆ‘ä»¬åªæ˜¯å°†å½“å‰çš„å­æ ‘å…‹éš†åˆ°æ­£åœ¨è¿›è¡Œçš„å·¥ä½œæ ‘ä¸­, è€Œä¸è¿›è¡Œä»»ä½•è°ƒæ•´. 


æˆ‘ä»¬ç°åœ¨æœ‰äº†`newChildElements`,å‡†å¤‡å¥½ä¸º _å·¥ä½œä¸­çš„`Fibre`_ åˆ›å»ºå­`Fibre`


#### 5.4.7 `reconcileChildrenArray`

![5-pic4](./imgs/5-pic6.png)


``` js
// Effect tags
const PLACEMENT = 1;
const DELETION = 2;
const UPDATE = 3;

function arrify(val) {
  return val == null ? [] : Array.isArray(val) ? val : [val];
}

function reconcileChildrenArray(wipFiber, newChildElements) {
  const elements = arrify(newChildElements);

  let index = 0;
  let oldFiber = wipFiber.alternate ? wipFiber.alternate.child : null;
  let newFiber = null;
  while (index < elements.length || oldFiber != null) {
    const prevFiber = newFiber;
    const element = index < elements.length && elements[index];
    const sameType = oldFiber && element && element.type == oldFiber.type;

    if (sameType) {
      newFiber = {
        type: oldFiber.type,
        tag: oldFiber.tag,
        stateNode: oldFiber.stateNode,
        props: element.props,
        parent: wipFiber,
        alternate: oldFiber,
        partialState: oldFiber.partialState,
        effectTag: UPDATE
      };
    }

    if (element && !sameType) {
      newFiber = {
        type: element.type,
        tag:
          typeof element.type === "string" ? HOST_COMPONENT : CLASS_COMPONENT,
        props: element.props,
        parent: wipFiber,
        effectTag: PLACEMENT
      };
    }

    if (oldFiber && !sameType) {
      oldFiber.effectTag = DELETION;
      wipFiber.effects = wipFiber.effects || [];
      wipFiber.effects.push(oldFiber);
    }

    if (oldFiber) {
      oldFiber = oldFiber.sibling;
    }

    if (index == 0) {
      wipFiber.child = newFiber;
    } else if (prevFiber && element) {
      prevFiber.sibling = newFiber;
    }

    index++;
  }
}
```

è¿™æ˜¯æœ¬åº“çš„æ ¸å¿ƒ, `æ­£åœ¨è¿›è¡Œçš„å·¥ä½œæ ‘`åœ¨ä¸æ–­å¢é•¿, æˆ‘ä»¬å†³å®šåœ¨æäº¤é˜¶æ®µå¯¹ _DOM_ åšä»€ä¹ˆæ›´æ”¹. 

- å¼€å§‹ä¹‹å‰, æˆ‘ä»¬ç¡®ä¿`newChildElements`æ˜¯ä¸€ä¸ªæ•°ç»„. ï¼ˆä¸ä¹‹å‰çš„å¯¹æ¯”ç®—æ³•ä¸åŒ, è¿™ä¸ªç®—æ³•æ€»æ˜¯ä¸å­æ•°ç»„ä¸€èµ·å·¥ä½œ, è¿™æ„å‘³ç€æˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨ç»„ä»¶çš„`render()`å‡½æ•°ä¸Šè¿”å›æ•°ç»„ï¼‰

- ç„¶åæˆ‘ä»¬å¼€å§‹æ¯”è¾ƒæ—§`Fibre`æ ‘çš„å­©å­å’Œæ–°å…ƒç´ ï¼ˆæˆ‘ä»¬å°†`Fibre`ä¸å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼‰. æ¥è‡ª _æ—§_ `Fibre`æ ‘çš„å­©å­ä»¬æ­£æ˜¯`wipFiber.alternate`çš„å­©å­ä»¬. æ–°å…ƒç´ æ˜¯æˆ‘ä»¬ä»`wipFiber.props.children`è°ƒç”¨æˆ–`wipFiber.stateNode.render()`è°ƒç”¨æ¥çš„. 

æˆ‘ä»¬çš„å¯¹æ¯”ç®—æ³•é€šè¿‡ ç¬¬ä¸€ä¸ªæ—§`Fibre`ï¼ˆåŒ¹é…`wipFiber.alternate.child`ï¼‰ä¸ç¬¬ä¸€å­å…ƒç´ ï¼ˆelements[0]ï¼‰, ç¬¬äºŒä¸ªæ—§`Fibre`ï¼ˆ`wipFiber.alternate.child.sibling`ï¼‰çš„ç¬¬äºŒå­å…ƒç´ ï¼ˆelements[1]ï¼‰ç­‰. å¯¹äºæ¯å¯¹ `oldFiber` - `element`: 

  - å¦‚æœ`oldFiber`å’Œ`element`åŒæ ·çš„`type`, å¥½æ¶ˆæ¯, è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¿ç•™æ—§çš„`stateNode`. æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºäºæ—§çš„`Fibre`çš„æ–°`Fibre`. æˆ‘ä»¬æ·»åŠ `UPDATE` `effectTag`. æˆ‘ä»¬å°†æ–°`Fibre`æ·»åŠ åˆ°`æ­£åœ¨è¿›è¡Œçš„å·¥ä½œæ ‘`ä¸­. 

  - å¦‚æœæˆ‘ä»¬`element`ä¸`oldFiber`æœ‰ä¸€ä¸ªä¸åŒ`type`å’Œæˆ‘ä»¬æ²¡æœ‰`oldFiber`ï¼ˆå› ä¸ºæˆ‘ä»¬æœ‰æ›´å¤šçš„æ–°å­©å­ï¼‰, æˆ‘ä»¬ç”¨`element`çš„ä¿¡æ¯åˆ›å»ºä¸€ä¸ªæ–°çš„`Fibre`. è¯·æ³¨æ„, è¿™ç§æ–°`Fibre`æ²¡æœ‰`alternate`, ä¹Ÿä¸ä¼šæœ‰`stateNode`ï¼ˆæˆ‘ä»¬å°†åœ¨`beginWork()`åˆ›å»º`stateNode`ï¼‰. è¯¥`Fibre`çš„`effectTag`æ˜¯`PLACEMENT`. 

  - å¦‚æœ`oldFiber`å’Œ`element`æœ‰ä¸åŒçš„`type`å’Œæœ‰`oldFiber`,ä¹Ÿæ²¡æœ‰ä»»ä½•çš„`element`ï¼ˆå› ä¸ºæˆ‘ä»¬æœ‰æ›´å¤š _æ—§_ å­©å­ï¼‰, æˆ‘ä»¬å°†æ ‡è®°`oldFiber`ä¸º`DELETION`. é‰´äºè¿™ç§`Fibre`ä¸æ˜¯æ­£åœ¨è¿›è¡Œå·¥ä½œçš„æ ‘çš„ä¸€éƒ¨åˆ†, æˆ‘ä»¬éœ€è¦å°†å®ƒæ·»åŠ åˆ°`wipFiber.effects`åˆ—è¡¨ä¸­, ä»¥ä¾¿æˆ‘ä»¬ä¸ä¼šä¸¢å¤±å®ƒçš„è¸ªè¿¹. 

> ä¸ React ä¸åŒçš„æ˜¯, æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ <kbd>key</kbd> æ¥è¿›è¡Œæ¯”å¯¹, æ‰€ä»¥æˆ‘ä»¬ä¸çŸ¥é“ä¸€ä¸ªå­©å­æ˜¯å¦ä»ä¹‹å‰çš„ä½ç½®ç§»åŠ¨è¿‡æ¥. 


#### 5.4.8 `cloneChildFibers`

![5-pic4](./imgs/5-pic7.png)

`updateClassComponent()` æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µ, æˆ‘ä»¬é‡‡å–äº†å¿«æ·æ–¹å¼, å°†æ—§çš„`Fibre`å­æ ‘å…‹éš†åˆ°æ­£åœ¨è¿›è¡Œä¸­çš„å·¥ä½œæ ‘, è€Œä¸æ˜¯è¿›è¡Œè°ƒæ•´. 

``` js
function cloneChildFibers(parentFiber) {
  const oldFiber = parentFiber.alternate;
  if (!oldFiber.child) {
    return;
  }

  let oldChild = oldFiber.child;
  let prevChild = null;
  while (oldChild) {
    const newChild = {
      type: oldChild.type,
      tag: oldChild.tag,
      stateNode: oldChild.stateNode,
      props: oldChild.props,
      partialState: oldChild.partialState,
      alternate: oldChild,
      parent: parentFiber
    };
    if (prevChild) {
      prevChild.sibling = newChild;
    } else {
      parentFiber.child = newChild;
    }
    prevChild = newChild;
    oldChild = oldChild.sibling;
  }
}
```

`cloneChildFibers()`å…‹éš†æ¯ä¸ª`wipFiber.alternate`å­©å­å¹¶å°†å…¶é™„åŠ åˆ°`æ­£åœ¨è¿›è¡Œä¸­çš„æ ‘`ä¸­. æˆ‘ä»¬ä¸éœ€è¦æ·»åŠ ä»»ä½•å†…å®¹, å› ä¸ºæˆ‘ä»¬ç¡®ä¿¡`effectTag`æ²¡æœ‰ä»»ä½•å˜åŒ–. 

#### 5.4.9 `completeWork`

![5-pic4](./imgs/5-pic8.png)


åœ¨`performUnitOfWork()`,å½“`wipFiber`æ²¡æœ‰æ–°çš„å­©å­æˆ–è€…æˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰å­©å­çš„å·¥ä½œæ—¶, æˆ‘ä»¬è¿è¡Œ`completeWork()`. 

``` js
function completeWork(fiber) {
  if (fiber.tag == CLASS_COMPONENT) {
    fiber.stateNode.__fiber = fiber;
  }

  if (fiber.parent) {
    const childEffects = fiber.effects || [];
    const thisEffect = fiber.effectTag != null ? [fiber] : [];
    const parentEffects = fiber.parent.effects || [];
    fiber.parent.effects = parentEffects.concat(childEffects, thisEffect);
  } else {
    pendingCommit = fiber;
  }
}
```

- `completeWork()`é¦–å…ˆæ›´æ–°ä¸`CLASS_COMPONENT`å®ä¾‹ç›¸å…³çš„`Fibre`å¼•ç”¨. ï¼ˆè¯´å®è¯, è¿™å¹¶ä¸æ˜¯çœŸçš„éœ€è¦åœ¨è¿™é‡Œ, ä½†å®ƒå¿…é¡»åœ¨æŸä¸ªåœ°æ–¹ï¼‰

- ç„¶åå®ƒå»ºç«‹ä¸€ä¸ª`effects`åˆ—è¡¨. è¯¥åˆ—è¡¨å°†åŒ…å«æ¥è‡ª æ­£åœ¨è¿›è¡Œä¸­çš„å­æ ‘ çš„æ‰€æœ‰`Fibre.effectTag`ï¼ˆå®ƒä¹ŸåŒ…å«æ¥è‡ªæ—§å­æ ‘çš„`Fibre`-`DELETION effectTag`ï¼‰. è¿™ä¸ªæƒ³æ³•æ˜¯åœ¨æ ¹`effects`åˆ—è¡¨ä¸­é›†åˆæ‰€æœ‰çš„`Fibre.effectTag`. 

- æœ€å, å¦‚æœ`Fibre`æ²¡æœ‰**parent**, æˆ‘ä»¬æ‹¿åˆ°äº† æ­£åœ¨è¿›è¡Œå·¥ä½œçš„æ ‘çš„æ ¹. æ‰€ä»¥æˆ‘ä»¬å®Œæˆäº†è¿™æ¬¡æ›´æ–°çš„æ‰€æœ‰å·¥ä½œ,å¹¶æ”¶é›†äº†æ‰€æœ‰çš„`effects`. æˆ‘ä»¬åˆ†é…æ ¹åˆ°`pendingCommit`,ä»¥ä¾¿`workLoop()`ä¸­`commitAllWork()`å¯ä»¥è°ƒç”¨.


#### 5.4.10 `commitAllWork`

![5-pic4](./imgs/5-pic9.png)


æˆ‘ä»¬éœ€è¦åšçš„æœ€åä¸€ä»¶äº‹æ˜¯: æ”¹å˜DOM. 

``` js
function commitAllWork(fiber) {
  fiber.effects.forEach(f => {
    commitWork(f);
  });
  fiber.stateNode._rootContainerFiber = fiber;
  nextUnitOfWork = null; // Reset
  pendingCommit = null;
}

function commitWork(fiber) {
  if (fiber.tag == HOST_ROOT) {
    return;
  }

  let domParentFiber = fiber.parent;
  while (domParentFiber.tag == CLASS_COMPONENT) {
    domParentFiber = domParentFiber.parent;
  }
  const domParent = domParentFiber.stateNode;

  if (fiber.effectTag == PLACEMENT && fiber.tag == HOST_COMPONENT) {
    domParent.appendChild(fiber.stateNode); // add
  } else if (fiber.effectTag == UPDATE) {
    updateDomProperties(fiber.stateNode, fiber.alternate.props, fiber.props);
  } else if (fiber.effectTag == DELETION) {
    commitDeletion(fiber, domParent);
  }
}

function commitDeletion(fiber, domParent) {
  let node = fiber;
  while (true) {
    if (node.tag == CLASS_COMPONENT) {
      node = node.child;
      continue;
    }
    domParent.removeChild(node.stateNode);
    while (node != fiber && !node.sibling) {
      node = node.parent;
    }
    if (node == fiber) {
      return;
    }
    node = node.sibling;
  }
}
```

`commitAllWork()`é¦–å…ˆè¿­ä»£`effects`ä¸­æ¯ä¸ªé¡¹è°ƒç”¨`commitWork()`. `commitWork()`æ£€æŸ¥æ¯æ ¹`Fibre`çš„`effectTag`: 


- å¦‚æœæ˜¯`PLACEMENT`, æˆ‘ä»¬æŸ¥æ‰¾çˆ¶DOMèŠ‚ç‚¹, ç„¶åç®€å•åœ°è¿½åŠ `Fibre.stateNode`. 

- å¦‚æœæ˜¯`UPDATE`, æˆ‘ä»¬ä¼šæŠŠ`stateNode`æ—§é“å…·å’Œæ–°é“å…·æ”¾åœ¨ä¸€èµ·, ç„¶å`updateDomProperties()`å†³å®šè¦æ›´æ–°ä»€ä¹ˆ. 

- å¦‚æœå®ƒæ˜¯`DELETION`å¹¶ä¸”`Fibre`æ˜¯ä¸»æœºç»„ä»¶, é‚£å¾ˆç®€å•, æˆ‘ä»¬åªæ˜¯`removeChild()`. ä½†æ˜¯å¦‚æœ`Fibre`æ˜¯ç±»ç»„ä»¶, åœ¨è°ƒç”¨`removeChild()`ä¹‹å‰, æˆ‘ä»¬éœ€è¦ä»`Fibre`å­æ ‘ä¸­,æ‰¾åˆ°éœ€è¦åˆ é™¤çš„æ‰€æœ‰ä¸»æœºç»„ä»¶. 

ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†æ‰€æœ‰çš„æ•ˆæœ, æˆ‘ä»¬å¯ä»¥é‡ç½®`nextUnitOfWork`å’Œ`pendingCommit`. æ­£åœ¨è¿›è¡Œçš„å·¥ä½œæ ‘ ä¸å†æ˜¯ æ­£åœ¨è¿›è¡Œä¸­çš„å·¥ä½œæ ‘, å¹¶æˆä¸ºæ—§æ ‘, å› æ­¤æˆ‘ä»¬å°†å…¶æ ¹æŒ‡å®šç»™`_rootContainerFiber`. ä¹‹å, æˆ‘ä»¬å®Œæˆå½“å‰çš„æ›´æ–°, æˆ‘ä»¬å‡†å¤‡å¼€å§‹ä¸‹ä¸€ä¸ªğŸš€

### 5.5 Didactçš„ä½¿ç”¨

å¦‚æœä½ æƒ³æŠŠæ‰€æœ‰çš„ä¸œè¥¿æ”¾åœ¨ä¸€èµ·, åªå…¬å¼€API, ä½ å¯ä»¥è¿™æ ·åš: 

``` js
function importDidact() {
  // ...
  // All the code we wrote
  // ...

  return {
    createElement,
    render,
    Component
  };
}

/** @jsx Didact.createElement */
const Didact = importDidact();

class HelloMessage extends Didact.Component {
  render() {
    return <div>Hello {this.props.name}</div>;
  }
}

Didact.render(
  <HelloMessage name="John" />,
  document.getElementById("container")
);
```

æˆ–è€…ä½ å¯ä»¥æŸ¥çœ‹çš„[codepen.IO](https://codepen.io/pomber/pen/veVOdd). æ‰€æœ‰è¿™äº›ä»£ç ä¹Ÿå¯ä»¥åœ¨[Didactçš„ä»“åº“](https://github.com/hexacta/didact)å’Œ[npm - didact](https://unpkg.com/didact)ä¸­è·å¾—. 


### 5.6 ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

Didactç¼ºå°‘å¾ˆå¤šReactçš„å‡½æ•°, ä½†æˆ‘ç‰¹åˆ«æœ‰å…´è¶£æ ¹æ®ä¼˜å…ˆçº§å®‰æ’æ›´æ–°: 

``` js
module.exports = {
  NoWork: 0, // No work is pending.
  SynchronousPriority: 1, // For controlled text inputs. Synchronous side-effects.
  TaskPriority: 2, // Completes at the end of the current tick.
  HighPriority: 3, // Interaction that needs to complete pretty soon to feel responsive.
  LowPriority: 4, // Data fetching, or result from updating stores.
  OffscreenPriority: 5, // Won't be visible but do the work in case it becomes visible.
};
```

[react-æº](https://github.com/facebook/react/blob/5f93ee6f6ce068228b01516c021c9054b627bf11/src/renderers/shared/fiber/ReactPriorityLevel.js)

æ‰€ä»¥å•Š, ä¸‹ä¸€ç¯‡æ–‡ç« å¯èƒ½ä¼šè¿™æ ·. 

å°±è¿™æ ·ï¼å¦‚æœä½ å–œæ¬¢å®ƒ, ä¸è¦å¿˜è®°æ‹æ‰‹ğŸ‘, åœ¨[Twitterä¸Šå…³æ³¨æˆ‘](https://twitter.com/pomber), å‘è¡¨è¯„è®ºå’Œæ‰€æœ‰è¿™äº›å†…å®¹. 

è°¢è°¢é˜…è¯». !!
