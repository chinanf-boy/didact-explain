
## 3. å®ä¾‹-å¯¹æ¯”å’Œè™šæ‹ŸDOM


> è¿™ä¸ªæ•…äº‹æ˜¯æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ„å»ºè‡ªå·±ç‰ˆæœ¬çš„Reactçš„ç³»åˆ—æ–‡ç« çš„ä¸€éƒ¨åˆ†ï¼š

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªåŸºäº`JSX`æè¿°-`åˆ›å»ºdomå…ƒç´ `çš„æœºåˆ¶ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»å¦‚ä½•`æ›´æ–°DOM`ã€‚

ç›´åˆ°æˆ‘ä»¬`setState`åœ¨åé¢çš„æ–‡ç« ä¸­ä»‹ç»æ—¶ï¼Œ`æ›´æ–°dom`çš„å”¯ä¸€æ–¹æ³•æ˜¯ä½¿ç”¨ä¸åŒçš„å…ƒç´ å†æ¬¡è°ƒç”¨`renderå‡½æ•°`ï¼ˆ[ä»ç¬¬ä¸€ç¯‡æ–‡ç« å¼€å§‹](#1.3-æ¸²æŸ“-dom-å…ƒç´ )ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³`æ¸²æŸ“ä¸€ä¸ªæ—¶é’Ÿ`ï¼Œä»£ç å°†æ˜¯ï¼š

``` js
const rootDom = document.getElementById("root");

function tick() {
  const time = new Date().toLocaleTimeString();
  const clockElement = <h1>{time}</h1>;
  render(clockElement, rootDom);
}

tick();
setInterval(tick, 1000);
```

> [>>> codepen.io](https://codepen.io/pomber/pen/KmXeXr?editors=0010)

ä½¿ç”¨è¯¥å‡½æ•°çš„å½“å‰ç‰ˆæœ¬ï¼Œè¿™ä¸èµ·ä½œç”¨ã€‚è€Œä¸æ˜¯æ›´æ–°æ¯ä¸ªå®ƒç›¸åŒçš„div å®ƒä¼šè¿½åŠ ä¸€ä¸ªæ–°çš„ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„ç¬¬ä¸€ç§æ–¹æ³•æ˜¯`æ›¿æ¢`æ¯ä¸ªæ›´æ–°çš„divã€‚

åœ¨å‡½æ•°ç»“æŸæ—¶ï¼Œæˆ‘ä»¬æ£€æŸ¥çˆ¶é¡¹æ˜¯å¦æœ‰ä»»ä½•å­é¡¹ï¼Œå¦‚æœæœ‰ï¼Œæˆ‘ä»¬ç”¨æ–°å…ƒç´ ç”Ÿæˆçš„domæ›¿æ¢å®ƒï¼š`rendertick-render`

``` js
function render(element, parentDom) {  
  
  // ...
  // Create dom from element
  // ...
  
  // Append or replace dom
  if (!parentDom.lastChild) { // æœ‰æ²¡æœ‰æœ€åå­©å­é˜¿
    parentDom.appendChild(dom);     
  } else {
    // æ¢äº†ä½ çš„å­©å­, å°±æ˜¯è¿™ä¹ˆï½ï½
    parentDom.replaceChild(dom, parentDom.lastChild);    
  }
}  
```

å¯¹äºè¿™ä¸ªå°ä¾‹å­ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆè¿è¡Œè‰¯å¥½ï¼Œä½†å¯¹äºæ›´å¤æ‚çš„æƒ…å†µï¼Œé‡æ–°åˆ›å»ºæ‰€æœ‰å­èŠ‚ç‚¹çš„æ€§èƒ½æˆæœ¬æ˜¯ä¸å¯æ¥å—çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦`ä¸€ç§æ–¹æ³•æ¥æ¯”è¾ƒå½“å‰å’Œå‰ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆçš„å…ƒç´ æ ‘`->`render`ï¼Œå¹¶åª`æ›´æ–°å·®å¼‚`ã€‚

---

æ‹ä¸€æ‹:

åˆ†æ¸…æœ‰`-5-`ç§åç§°

1. çœŸå®-html-æ ‘ 
2. Didact å…ƒç´  `{type, props}`
3. è™šæ‹Ÿ-Dom-æ ‘
  - 3.1 è™šæ‹Ÿ-dom-å…ƒç´  `{ dom, element, childInstance }`
  - 3.2 è™šæ‹Ÿ-ç»„ä»¶-å…ƒç´  `{ dom, element, childInstance, publicInstance }`

---

### 3.1 è™šæ‹ŸDOMå’Œå¯¹æ¯”

`React`ç§°è¿™ç§â€œå·®å¼‚åŒ–â€[è¿›ç¨‹è°ƒèŠ‚](https://facebook.github.io/react/docs/reconciliation.html)ã€‚

å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿ç•™-å…ˆå‰æ¸²æŸ“çš„æ ‘-ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å°†å®ƒä¸-æ–°æ ‘-è¿›è¡Œ`æ¯”è¾ƒ`ã€‚

æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å°†ç»´æŠ¤æˆ‘ä»¬è‡ªå·±çš„-DOMç‰ˆæœ¬ï¼Œä¸€ä¸ªè™šæ‹Ÿçš„DOMã€‚

ä»€ä¹ˆåº”è¯¥æ˜¯è¿™ä¸ª-è™šæ‹ŸDOM-ä¸­çš„â€œ`èŠ‚ç‚¹ã€Œnodeã€`â€ï¼Ÿ

ä¸€ç§é€‰æ‹©æ˜¯åªä½¿ç”¨`Didact Elements`ï¼Œå®ƒä»¬å·²ç»æœ‰ä¸€ä¸ªprops.childrenå±æ€§ï¼Œå…è®¸æˆ‘ä»¬`ä»¥æ ‘çš„å½¢å¼`å¯¼èˆªå®ƒä»¬ã€‚

ä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œ

- ä¸€ä¸ªæ˜¯æˆ‘ä»¬éœ€è¦åœ¨`è™šæ‹ŸDOMçš„æ¯ä¸ªèŠ‚ç‚¹`ä¸Šä¿ç•™ä¸€ä¸ªå¯¹`çœŸå®DOMèŠ‚ç‚¹`çš„å¼•ç”¨ï¼Œä»¥ä¾¿ä½¿å¯¹æ¯”æ›´å®¹æ˜“ï¼Œæˆ‘ä»¬æ›´æ„¿æ„ä¿æŒè¿™äº›å…ƒç´ ä¸å˜ã€‚

- ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼ˆç¨å-ä¸‹ä¸€ç« èŠ‚ï¼‰æˆ‘ä»¬å°†éœ€è¦æ”¯æŒå…·æœ‰è‡ªå·±çŠ¶æ€çš„`ç»„ä»¶{Component}`ï¼Œå¹¶ä¸”å…ƒç´ æ— æ³•å¤„ç†å®ƒã€‚

### 3.2 å®ä¾‹-Instance

æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªæ–°çš„æœ¯è¯­ï¼š`å®ä¾‹-Instance`ã€‚

ä¸€ä¸ªå®ä¾‹-è¡¨ç¤ºå·²å‘ˆç°-ç»™DOMçš„å…ƒç´ ã€‚

å®ƒæ˜¯å…·æœ‰ä¸‰ä¸ªå±æ€§çš„çº¯JSå¯¹è±¡ï¼š`element`ï¼Œ`dom`ï¼Œå’Œ`childInstances`ã€‚

`element` -> `Didact å…ƒç´ `

`dom` -> `html å…ƒç´ `

`childInstances`æ˜¯ä¸€ä¸ªåŒ…å«å…ƒç´ -å­å…ƒç´ å®ä¾‹çš„æ•°ç»„ã€‚

> è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼•ç”¨çš„å®ä¾‹ä¸[Dan Abramovåœ¨React Componentsï¼ŒElementså’ŒInstancesä¸­ä½¿ç”¨çš„å®ä¾‹](https://medium.com/@dan_abramov/react-components-elements-and-instances-90800811f8ca)ä¸åŒã€‚ä»–å¼•ç”¨äº†`å…¬å…±å®ä¾‹`ï¼Œè¿™æ˜¯Reactåœ¨è°ƒç”¨ç»§æ‰¿è‡ªç±»çš„æ„é€ å‡½æ•°æ—¶å¾—åˆ°çš„`React.Component`ã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥çš„å¸–å­ä¸­å°†`å…¬å¼€å®ä¾‹`æ·»åŠ åˆ°`Didact`ã€‚

æ¯ä¸ªDOMèŠ‚ç‚¹éƒ½ä¼šæœ‰ä¸€ä¸ªåŒ¹é…çš„å®ä¾‹ã€‚åè°ƒç®—æ³•çš„ä¸€ä¸ªç›®æ ‡æ˜¯å°½å¯èƒ½é¿å…-åˆ›å»ºæˆ–åˆ é™¤å®ä¾‹ã€‚åˆ›å»ºå’Œåˆ é™¤å®ä¾‹æ„å‘³ç€æˆ‘ä»¬ä¹Ÿå°†-ä¿®æ”¹DOMæ ‘ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°åˆ©ç”¨å®ä¾‹çš„`æ¬¡æ•°è¶Šå¤š`ï¼Œä¿®æ”¹DOMæ ‘çš„`æ¬¡æ•°è¶Šå°‘`ã€‚

### 3.3 é‡æ„

è®©æˆ‘ä»¬é‡å†™æˆ‘ä»¬çš„`render`å‡½æ•°ï¼Œä¿æŒåŒæ ·çš„åè°ƒç®—æ³•ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª`instantiate`å‡½æ•°æ¥`åˆ›å»º`ä¸€ä¸ªç»™å®šå…ƒç´ çš„-å®ä¾‹ï¼ˆåŠå…¶å­å…ƒç´ ï¼‰ï¼š

``` js
// --------------- è¿è¡Œä¸€æ¬¡ å¼€å§‹------
let rootInstance = null;

function render(element, container) {

  const prevInstance = rootInstance; // 1-è™šæ‹Ÿdomä¸»æ ‘å¹²- == null
  const nextInstance = reconcile(container, prevInstance, element); 
  rootInstance = nextInstance; // 2-æ”¯æ ‘å¹²- é¢†å¤´å•¦
}

function reconcile(parentDom, instance, element) {
  if (instance == null) {
    // ä¸€å¼€å§‹çš„ 1-è™šæ‹Ÿdomä¸»æ ‘å¹²- null
    const newInstance = instantiate(element); // ä»ä¸€ä¸ªÂ·Didactå…ƒç´ Â·-> å®ä¾‹
    parentDom.appendChild(newInstance.dom); // -html-å…ƒç´ æ·»åŠ 
    return newInstance;
  } else {
    const newInstance = instantiate(element);
    parentDom.replaceChild(newInstance.dom, instance.dom);
    return newInstance;
  }
}

// --------------- è¿è¡Œä¸€æ¬¡ ç»“æŸ------

// ------ é€’å½’ - instantiate - è¿è¡Œä¸€æ¬¡ä»¥ä¸Š -----
function instantiate(element) {
  const { type, props } = element;

  // Create DOM element
  const isTextElement = type === "TEXT ELEMENT";
  const dom = isTextElement
    ? document.createTextNode("")
    : document.createElement(type);

  // Add event listeners
  const isListener = name => name.startsWith("on");
  Object.keys(props).filter(isListener).forEach(name => {
    const eventType = name.toLowerCase().substring(2);
    dom.addEventListener(eventType, props[name]);
  });

  // Set properties
  const isAttribute = name => !isListener(name) && name != "children";
  Object.keys(props).filter(isAttribute).forEach(name => {
    dom[name] = props[name];
  });
// 1. dom æ„é€ å®Œæˆ

  // Instantiate and append children
  const childElements = props.children || [];

// 2. è½¬æŠ˜ç‚¹-é€’å½’-å­©å­ -> å˜ å®ä¾‹æ•°ç»„
  const childInstances = childElements.map(instantiate);
// 3. è·å– å­©å­-html-æ•°ç»„
  const childDoms = childInstances.map(childInstance => childInstance.dom);

// 4. å„¿/å¥³ åŠ å…¥ çˆ¸çˆ¸å¦ˆå¦ˆçš„æ€€æŠ±, ã€Œ html ç»„åˆ ã€
// æ­£å¦‚ -2- æ‰€åšçš„-é€’å½’æœ¬å‡½æ•°
// æ‰€ä»¥-å­™å­/å­™å¥³-å·²ç»-åŠ å…¥-å„¿/å¥³çš„æ€€æŠ±äº†
  childDoms.forEach(childDom => dom.appendChild(childDom));

  const instance = { dom, element, childInstances };
  
// `element` -> `Didact å…ƒç´ `

// `dom` -> `html å…ƒç´ `

// `childInstances`æ˜¯ä¸€ä¸ªåŒ…å«å…ƒç´ -å­å…ƒç´ å®ä¾‹çš„æ•°ç»„ã€‚

  return instance;
}
```

`instantiate-ä»£ç `å’Œ`ä»¥å‰-render`ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ­£åœ¨å°†æœ€åä¸€æ¬¡è°ƒç”¨çš„å®ä¾‹`-instance-`å­˜å‚¨èµ·æ¥ã€‚è€Œ`render`æˆ‘ä»¬å°†-å®ä¾‹åŒ–ä¸­çš„è°ƒèŠ‚-åŠŸèƒ½åˆ†å¼€ã€‚

ä¸ºäº†é‡æ–°ä½¿ç”¨DOMèŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥-æ›´æ–°DOMå±æ€§ï¼ˆclassNameï¼Œstyleï¼ŒonClickè€Œæ— éœ€åˆ›å»ºä¸€ä¸ª`æ–°çš„DOMèŠ‚ç‚¹`ç­‰ï¼‰ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬å°†-å½“å‰è®¾ç½®å±æ€§çš„ä»£ç éƒ¨åˆ†-æå–ä¸º-æ›´æ–°å®ƒä»¬çš„é€šç”¨å‡½æ•°`updateDomProperties`ï¼š
 
``` js
function instantiate(element) {
  const { type, props } = element;

  // Create DOM element
  const isTextElement = type === "TEXT ELEMENT";
  const dom = isTextElement
    ? document.createTextNode("")
    : document.createElement(type);

  updateDomProperties(dom, [], props); // <------

  // Instantiate and append children
  const childElements = props.children || [];
  const childInstances = childElements.map(instantiate);
  const childDoms = childInstances.map(childInstance => childInstance.dom);
  childDoms.forEach(childDom => dom.appendChild(childDom));

  const instance = { dom, element, childInstances };
  return instance;
}

function updateDomProperties(dom, prevProps, nextProps) {
  const isEvent = name => name.startsWith("on");
  const isAttribute = name => !isEvent(name) && name != "children";

// preProps Remove
  // Remove event listeners
  Object.keys(prevProps).filter(isEvent).forEach(name => {
    const eventType = name.toLowerCase().substring(2);
    dom.removeEventListener(eventType, prevProps[name]);
  });

  // Remove attributes
  Object.keys(prevProps).filter(isAttribute).forEach(name => {
    dom[name] = null;
  });

// nextProps Add
  // Set attributes
  Object.keys(nextProps).filter(isAttribute).forEach(name => {
    dom[name] = nextProps[name];
  });

  // Add event listeners
  Object.keys(nextProps).filter(isEvent).forEach(name => {
    const eventType = name.toLowerCase().substring(2);
    dom.addEventListener(eventType, nextProps[name]);
  });
}
```

> `updateDomProperties`ä»domèŠ‚ç‚¹ä¸­åˆ é™¤æ‰€æœ‰`æ—§å±æ€§`ï¼Œç„¶å`æ·»åŠ `æ‰€æœ‰`æ–°å±æ€§`ã€‚

âš ï¸å¯æ˜¯å› ä¸º-`[] == prevProps`-->

å¦‚æœ-å±æ€§-å‘ç”Ÿäº†å˜åŒ–ï¼Œå®ƒä¾ç„¶ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¼šè¿›è¡Œå¤§é‡ä¸å¿…è¦çš„æ›´æ–°ï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œç°åœ¨å°±è®©å®ƒä¿æŒåŸæ ·ã€‚

### 3.4 é‡ç”¨DOMèŠ‚ç‚¹

æˆ‘ä»¬è¯´-åè°ƒç®—æ³•-éœ€è¦å°½å¯èƒ½å¤šåœ°é‡ç”¨-DOMèŠ‚ç‚¹ã€‚è®©æˆ‘ä»¬ä¸ºè¯¥Â·reconcileÂ·å‡½æ•°æ·»åŠ ä¸€ä¸ªéªŒè¯ï¼Œä»¥æ£€æŸ¥ä¹‹å‰æ¸²æŸ“çš„å…ƒç´ `type`æ˜¯å¦ä¸æˆ‘ä»¬å½“å‰æ­£åœ¨æ¸²æŸ“çš„å…ƒç´ ç›¸åŒã€‚å¦‚æœ`type`ç›¸åŒï¼Œæˆ‘ä»¬å°†é‡æ–°ä½¿ç”¨å®ƒï¼ˆæ›´æ–°å±æ€§ä»¥åŒ¹é…æ–°çš„å±æ€§ï¼‰ï¼š

``` js
function reconcile(parentDom, instance, element) {
  if (instance == null) {
    // Create instance
    const newInstance = instantiate(element);
    parentDom.appendChild(newInstance.dom);
    return newInstance;
  } else if (instance.element.type === element.type) {
    // ç›¸åŒç±»å‹
    // Update instance
    // 1. åŠ å…¥å±æ€§
    updateDomProperties(instance.dom, instance.element.props, element.props);
    // 2. ä½“ä¼š-Didactå…ƒç´ 
    instance.element = element;
    return instance;
  } else {
    // Replace instance
    const newInstance = instantiate(element);
    parentDom.replaceChild(newInstance.dom, instance.dom);
    return newInstance;
  }
}
```

### 3.5 child-åè°ƒ

è¯¥`reconcile`åŠŸèƒ½ç¼ºå°‘ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œå®ƒä½¿`children`ä¸å—å½±å“ã€‚`child-åè°ƒ`æ˜¯`React`çš„ä¸€ä¸ªå…³é”®æ–¹é¢ï¼Œå®ƒéœ€è¦å…ƒç´ `ï¼ˆkeyï¼‰`ä¸­çš„é¢å¤–å±æ€§æ¥åŒ¹é…-å…ˆå‰å’Œå½“å‰æ ‘ä¸­çš„`child`ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¿™ç§ç®—æ³•çš„ç®€æ˜“ç‰ˆæœ¬ï¼Œå®ƒåªæ¯”è¾ƒ-`children-æ•°ç»„`ä¸­ç›¸åŒä½ç½®çš„å­©å­ã€‚è¿™ç§æ–¹æ³•çš„æˆæœ¬æ˜¯ï¼Œæˆ‘ä»¬å¤±å»äº†-é‡ç”¨DOMèŠ‚ç‚¹çš„æœºä¼šï¼Œå½“ä»–ä»¬æ”¹å˜æ¸²æŸ“ä¹‹é—´çš„å­æ•°ç»„çš„`é¡ºåº`æ—¶ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†å…ˆå‰çš„å­å®ä¾‹instance.childInstancesä¸å­å…ƒç´ è¿›è¡ŒåŒ¹é…element.props.childrenï¼Œç„¶åreconcileé€ä¸ªè°ƒç”¨ã€‚æˆ‘ä»¬è¿˜ä¿ç•™æ‰€æœ‰è¿”å›çš„å®ä¾‹ï¼Œreconcileä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ›´æ–°childInstancesï¼š

``` js

function reconcile(parentDom, instance, element) {
  if (instance == null) {
    // Create instance
    const newInstance = instantiate(element);
    parentDom.appendChild(newInstance.dom);
    return newInstance;
  } else if (instance.element.type === element.type) {
    // Update instance
    updateDomProperties(instance.dom, instance.element.props, element.props);
  // 1. æ›¿æ¢-æ–°çš„å­©å­æ•°ç»„
    instance.childInstances = reconcileChildren(instance, element);

    instance.element = element;
    return instance;
  } else {
    // Replace instance
    const newInstance = instantiate(element);
    parentDom.replaceChild(newInstance.dom, instance.dom);
    return newInstance;
  }
}

function reconcileChildren(instance, element) {
  // instance æ—§
  // element æ–°
  const dom = instance.dom;
  const childInstances = instance.childInstances;
  const nextChildElements = element.props.children || [];
  const newChildInstances = []; // æ–°çš„å­©å­æ•°ç»„

  const count = Math.max(childInstances.length, nextChildElements.length); // æ¯”è¾ƒè°-å¤§

  for (let i = 0; i < count; i++) {
    const childInstance = childInstances[i];
    const childElement = nextChildElements[i];

// 2. é€’å½’ - ä¸Šä¸€å±‚å‡½æ•° reconcile
    const newChildInstance = reconcile(dom, childInstance, childElement);
    newChildInstances.push(newChildInstance);
  }
  return newChildInstances;
}
```

### 3.6 åˆ é™¤DOMèŠ‚ç‚¹

å¦‚æœ`nextChildElements`é•¿äº`childInstances`ï¼Œ`reconcileChildren`å°†ä¸ºæ‰€æœ‰é¢å¤–çš„`å­å…ƒç´ `è°ƒç”¨`reconcile`ä¸€ä¸ª`undefined`å®ä¾‹ã€‚è¿™ä¸åº”è¯¥æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®ƒ`if (instance == null)`ä¼šç…§é¡¾å®ƒå¹¶åˆ›å»º`æ–°çš„å®ä¾‹`ã€‚

ä½†æ˜¯åè¿‡æ¥å‘¢ï¼Ÿå½“`childInstances`å®ƒæ¯”`nextChildElements`ä¼ é€’`undefinedå…ƒç´ `çš„æ—¶é—´é•¿ï¼Œ`reconcile`å¹¶è¯•å›¾è·å–æ—¶æŠ›å‡ºé”™è¯¯`element.type`ã€‚

è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬éœ€è¦ä»-DOMä¸­åˆ é™¤å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬æ²¡æœ‰è€ƒè™‘è¿‡è¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼Œæ£€æŸ¥ 1. `element == nullåœ¨-reconcileåŠŸèƒ½`å’Œ 2. `è¿‡æ»¤childInstancesçš„-reconcileChildrenåŠŸèƒ½`ï¼š

``` js
function reconcile(parentDom, instance, element) {
  if (instance == null) {
    // Create instance
    const newInstance = instantiate(element);
    parentDom.appendChild(newInstance.dom);
    return newInstance;
  } else if (element == null) { // <---- 1
    // Remove instance
    parentDom.removeChild(instance.dom);
    return null;
  } else if (instance.element.type === element.type) {
    // Update instance
    updateDomProperties(instance.dom, instance.element.props, element.props);
    instance.childInstances = reconcileChildren(instance, element);
    instance.element = element;
    return instance;
  } else {
    // Replace instance
    const newInstance = instantiate(element);
    parentDom.replaceChild(newInstance.dom, instance.dom);
    return newInstance;
  }
}

function reconcileChildren(instance, element) {
  const dom = instance.dom;
  const childInstances = instance.childInstances;
  const nextChildElements = element.props.children || [];
  const newChildInstances = [];
  const count = Math.max(childInstances.length, nextChildElements.length);
  for (let i = 0; i < count; i++) {
    const childInstance = childInstances[i];
    const childElement = nextChildElements[i];
    const newChildInstance = reconcile(dom, childInstance, childElement);
    newChildInstances.push(newChildInstance);
  }
  return newChildInstances.filter(instance => instance != null); // <---- 2
}
```

### 3.7 æ¦‚è¦

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¢å¼ºäº†`Didact`ä»¥å…è®¸æ›´æ–°DOMã€‚æˆ‘ä»¬è¿˜æé«˜äº†æ•ˆç‡ï¼Œé€šè¿‡`é‡ç”¨DOMèŠ‚ç‚¹`æ¥é¿å…å¯¹-`DOMæ ‘çš„å¤§éƒ¨åˆ†æ›´æ”¹`ã€‚è¿™ä¹Ÿå…·æœ‰ä¿æŒä¸€äº›-`DOMå†…éƒ¨çŠ¶æ€`ï¼ˆå¦‚æ»šåŠ¨ä½ç½®æˆ–ç„¦ç‚¹ï¼‰çš„è‰¯å¥½å‰¯ä½œç”¨ã€‚

æˆ‘[æ›´æ–°äº†ä»¥å‰çš„codepen](https://codepen.io/pomber/pen/WjLqYW?editors=0010)ã€‚å®ƒè°ƒç”¨`renderçŠ¶æ€ï¼ˆstoriesæ•°ç»„ï¼‰`ä¸­çš„æ¯ä¸ªæ›´æ”¹ã€‚å¦‚æœDOMèŠ‚ç‚¹é‡æ–°åˆ›å»ºï¼Œæ‚¨å¯ä»¥æ£€æŸ¥å¼€å‘å·¥å…·ã€‚

![3-codepen](./imgs/3-codepen.gif)

> [>>> codepen.io](https://codepen.io/pomber/pen/WjLqYW?editors=0010)

å½“æˆ‘ä»¬è°ƒç”¨`renderæ ‘`çš„æ ¹æ—¶ï¼Œ`-åè°ƒ-`é€‚ç”¨äºæ•´æ£µæ ‘ã€‚åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»`ç»„ä»¶{Component}`ï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿåè°ƒç®—æ³•é€‚ç”¨äºåªæ˜¯å—å½±å“çš„å­æ ‘ï¼š

åœ¨GitHubä¸Šæ£€æŸ¥[è¿™ ä¸‰ä¸ª æäº¤](https://github.com/hexacta/didact/commit/6f5fdb7331ed77ba497fa5917d920eafe1f4c8dc)ï¼Œä»¥æŸ¥çœ‹ä»£ç å¦‚ä½•ä»å‰ä¸€ç¯‡æ–‡ç« ä¸­æ›´æ”¹ã€‚

---

[Didact: Component and State](https://engineering.hexacta.com/didact-components-and-state-53ab4c900e37) |-|_|ğŸŒŸ| [Didactï¼šç»„ä»¶å’ŒçŠ¶æ€](#ç»„ä»¶å’ŒçŠ¶æ€)
