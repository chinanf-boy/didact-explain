

## 1. æ¸²æŸ“DOMå…ƒç´ 

> è¿™ä¸ªæ•…äº‹æ˜¯æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ„å»ºè‡ªå·±ç‰ˆæœ¬çš„Reactçš„ç³»åˆ—æ–‡ç« çš„ä¸€éƒ¨åˆ†ï¼š

### 1.1 DOMå®¡æŸ¥

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æˆ‘ä»¬å°†ä½¿ç”¨çš„DOM APIï¼š

``` js
// Get an element by id
const domRoot = document.getElementById("root");
// Create a new element given a tag name
const domInput = document.createElement("input");
// Set properties
domInput["type"] = "text";
domInput["value"] = "Hi world";
domInput["className"] = "my-class";
// Listen to events
domInput.addEventListener("change", e => alert(e.target.value));
// Create a text node
const domText = document.createTextNode("");
// Set text node content
domText["nodeValue"] = "Foo";
// Append an element
domRoot.appendChild(domInput);
// Append a text node (same as previous)
domRoot.appendChild(domText);
```

> [>>> codepen.io](https://codepen.io/pomber/pen/aWBLJR)

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ­£åœ¨è®¾ç½®[å…ƒç´ å±æ€§è€Œä¸æ˜¯å±æ€§](http://stackoverflow.com/questions/6003819/properties-and-attributes-in-html)ã€‚è¿™æ„å‘³ç€åªå…è®¸æœ‰æ•ˆçš„å±æ€§ã€‚

### 1.2 Didactå…ƒç´ 

æˆ‘ä»¬å°†ä½¿ç”¨æ™®é€šçš„JSå¯¹è±¡æ¥æè¿°éœ€è¦æ¸²æŸ“çš„ä¸œè¥¿ã€‚æˆ‘ä»¬å°†å®ƒä»¬ç§°ä¸º`Didact Elements`ã€‚

è¿™äº›å…ƒç´ æœ‰ä¸¤ä¸ªå¿…éœ€çš„å±æ€§ï¼š`type`å’Œ`props`ã€‚

- `type`å¯ä»¥æ˜¯ä¸€ä¸ª**{å­—ç¬¦ä¸²string}**æˆ–ä¸€ä¸ª**{å‡½æ•°function}**, ä½†æˆ‘ä»¬å°†åªä½¿ç”¨-å­—ç¬¦ä¸²-ï¼Œç›´åˆ°æˆ‘ä»¬åœ¨ç¨åçš„å¸–å­ä¸­å¼•å…¥-ç»„ä»¶-ã€‚

- `props`æ˜¯å¯ä»¥ä¸ºç©ºçš„å¯¹è±¡ï¼ˆä½†ä¸ä¸ºç©ºï¼‰ã€‚`props`å¯èƒ½æœ‰ä¸€ä¸ª`children`å±æ€§ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ª`Didactå…ƒç´ `çš„æ•°ç»„ã€‚

> æˆ‘ä»¬ä¼šå¾ˆå¤šåœ°ä½¿ç”¨`Didact Elements`ï¼Œæ‰€ä»¥ä»ç°åœ¨å¼€å§‹æˆ‘ä»¬åªä¼šç§°å®ƒä»¬ä¸º**{å…ƒç´ element}**, ä¸è¦ä¸`HTML element`æ··æ·†.

ä¾‹å¦‚ï¼Œåƒè¿™æ ·çš„ä¸€ä¸ªå…ƒç´ ï¼š

``` js
const element = {
  type: "div",
  props: {
    id: "container",
    children: [
      { type: "input", props: { value: "foo", type: "text" } },
      { type: "a", props: { href: "/bar" } },
      { type: "span", props: {} }
    ]
  }
};
```

æè¿°è¿™ä¸ªdom:

``` html
<div id="container">
  <input value="foo" type="text">
  <a href="/bar"></a>
  <span></span>
</div>
```

---

`Didact-å…ƒç´ `ä¸`React-å…ƒç´ `éå¸¸ç›¸ä¼¼ã€‚

ä½†æ˜¯é€šå¸¸ä½ åœ¨ä½¿ç”¨`React`æ—¶ä¸ä¼šåˆ›å»º`React-å…ƒç´ `ä½œä¸ºJSå¯¹è±¡ï¼Œ

ä½ å¯èƒ½ä½¿ç”¨`JSX`æˆ–è€…ç”šè‡³æ˜¯`createElement`ã€‚

æˆ‘ä»¬å°†åœ¨`Didact`ä¸­åšåŒæ ·çš„äº‹æƒ…ï¼Œä½†æˆ‘ä»¬å°†ä¼šåœ¨ç³»åˆ—ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æè¿°-`createElement`-çš„ä»£ç ã€‚

---

### 1.3 æ¸²æŸ“-DOM-å…ƒç´ 

ä¸‹ä¸€æ­¥æ˜¯å°†å…ƒç´ åŠå…¶å­å…ƒç´ å‘ˆç°ç»™domã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª`render`å‡½æ•°ï¼ˆç›¸å½“äº`ReactDOM.render`ï¼‰æ¥æ”¶ä¸€ä¸ªå…ƒç´ å’Œä¸€ä¸ª`domå®¹å™¨`ã€‚

è¯¥å‡½æ•°åº”è¯¥åˆ›å»ºç”±`element`å®šä¹‰çš„`domå­æ ‘`å¹¶å°†å…¶é™„åŠ åˆ°`å®¹å™¨`ä¸­ï¼š

``` js
function render(element, parentDom) {
  const { type, props } = element; // è·å–ç±»å‹ å’Œ å±æ€§å¯¹è±¡
  const dom = document.createElement(type); // åˆ›å»º-ç±»å‹-element
  const childElements = props.children || []; // è·å–-å­©å­
  childElements.forEach(childElement => render(childElement, dom)); // æ¯ä¸ªå­©å­ éƒ½è¦åŠ å…¥-çˆ¸çˆ¸å¦ˆå¦ˆ-çš„æ€€æŠ±
  // 
  parentDom.appendChild(dom); // çˆ¸çˆ¸å¦ˆå¦ˆåŠ å…¥çˆ·çˆ·å¥¶å¥¶çš„æ€€æŠ±
}
```

æˆ‘ä»¬ä»ç„¶ç¼ºå°‘`å±æ€§`å’Œ`äº‹ä»¶ç›‘å¬å™¨`ã€‚è®©æˆ‘ä»¬`props`ç”¨`Object.keys`å‡½æ•°`è¿­ä»£`å±æ€§åç§°å¹¶ç›¸åº”åœ°-è®¾ç½®-å®ƒä»¬ï¼š

``` js
function render(element, parentDom) {
  const { type, props } = element;
  const dom = document.createElement(type);

  const isListener = name => name.startsWith("on");
  // æ˜¯å¦å¼€å¤´-on
  Object.keys(props).filter(isListener).forEach(name => {
    const eventType = name.toLowerCase().substring(2); // å–ä¸¤ä½å
    dom.addEventListener(eventType, props[name]);
  });
  // æ¯ä¸€ä¸ªå¼€å¤´-on çš„å±æ€§-å¯¹åº”-å‡½æ•° props[name] - >ç”¨-dom-addEvent æ¥è¿

  const isAttribute = name => !isListener(name) && name != "children";
  // ä¸æ˜¯-ç›‘å¬äº‹ä»¶ å’Œ ä¸èƒ½æ˜¯-å­©å­ 

  Object.keys(props).filter(isAttribute).forEach(name => {
    dom[name] = props[name];
  });
 // è¿‡æ»¤å‡ºæ¥çš„å±æ€§ - èµ‹äºˆ - > dom
  const childElements = props.children || [];
  childElements.forEach(childElement => render(childElement, dom));

  parentDom.appendChild(dom);
}
```

### 1.4 æ¸²æŸ“DOMæ–‡æœ¬èŠ‚ç‚¹

`render`å‡½æ•°ä¸æ”¯æŒçš„ä¸€ä»¶äº‹æ˜¯`æ–‡æœ¬èŠ‚ç‚¹`ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰æ–‡æœ¬å…ƒç´ çš„å¤–è§‚ã€‚ä¾‹å¦‚ï¼Œ`<span>Foo</span>`åœ¨`React`ä¸­æè¿°çš„å…ƒç´ å¦‚ä¸‹æ‰€ç¤ºï¼š

``` js
const reactElement = {
  type: "span",
  props: {
    children: ["Foo"] // æ˜¯å­©å­, ä½†ä¹Ÿåªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
  }
};
```

è¯·æ³¨æ„ï¼Œ`children`ï¼Œåªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² ï¼Œè€Œä¸æ˜¯å¦ä¸€ä¸ªå…ƒç´ å¯¹è±¡ã€‚

è¿™è¿èƒŒäº†æˆ‘ä»¬å¦‚ä½•å®šä¹‰`Didactå…ƒç´ `ï¼š`children`åº”è¯¥æ˜¯å…ƒç´ çš„æ•°ç»„å’Œæ‰€æœ‰å…ƒç´ åº”è¯¥æœ‰`type`å’Œ`props`ã€‚

å¦‚æœæˆ‘ä»¬éµå¾ªè¿™äº›è§„åˆ™ï¼Œæˆ‘ä»¬å°†æ¥ä¼šå°‘ä¸€äº›`if`åˆ¤æ–­ã€‚

å› æ­¤ï¼Œ`Didact Text Elements`å°†`type==â€œTEXT ELEMENTâ€`ç›¸ç­‰ï¼Œå®é™…æ–‡æœ¬å°†ä½äº`nodeValue`å±æ€§ä¸­ã€‚

åƒè¿™ä¸ªï¼š

``` js
const textElement = {
  type: "span",
  props: {
    children: [
      {
        type: "TEXT ELEMENT", // 1
        props: { nodeValue: "Foo" } // 2
      }
    ]
  }
};
```

ç°åœ¨æˆ‘ä»¬å·²ç»è§„èŒƒäº†æ–‡æœ¬å…ƒç´ çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦å¯ä»¥å‘ˆç°å®ƒ, ä»¥ä¾¿ä¸å…¶ä»–å…ƒç´ ä¸€æ ·ï¼Œè€ŒåŒºåˆ«ä¹Ÿå°±æ˜¯{`type: "TEXT ELEMENT"`}ã€‚

æˆ‘ä»¬åº”è¯¥ä½¿ç”¨`createTextNode`ï¼Œè€Œä¸æ˜¯ä½¿ç”¨`createElement`ã€‚

å°±æ˜¯è¿™æ ·ï¼Œ`nodeValue`å°†ä¼šåƒå…¶ä»–å±æ€§ä¸€æ ·è®¾ç½®ã€‚

``` js
function render(element, parentDom) {
  const { type, props } = element;

  // Create DOM element
  const isTextElement = type === "TEXT ELEMENT"; // æ–‡æœ¬ç±»å‹åˆ¤å®š
  const dom = isTextElement
    ? document.createTextNode("")
    : document.createElement(type);

  // Add event listeners
  const isListener = name => name.startsWith("on");
  Object.keys(props).filter(isListener).forEach(name => {
    const eventType = name.toLowerCase().substring(2);
    dom.addEventListener(eventType, props[name]);
  });

  // Set properties
  const isAttribute = name => !isListener(name) && name != "children";
  Object.keys(props).filter(isAttribute).forEach(name => {
    dom[name] = props[name];
  });

  // Render children
  const childElements = props.children || [];
  childElements.forEach(childElement => render(childElement, dom));

  // Append to parent
  parentDom.appendChild(dom);
}
```

### 1.5 æ¦‚è¦

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`renderå‡½æ•°`ï¼Œå…è®¸æˆ‘ä»¬å°†`ä¸€ä¸ªå…ƒç´ {element}åŠå…¶å­å…ƒç´ {children}`å‘ˆç°ç»™-DOMã€Œ`parentDom.appendChild(dom);`ã€ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦çš„æ˜¯`createElement`çš„ç®€å•æ–¹æ³•ã€‚

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å°†è®©`JSXä¸Didact`ä¸€èµ·å·¥ä½œã€‚

å¦‚æœæ‚¨æƒ³å°è¯•æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢ç¼–å†™çš„ä»£ç ï¼Œè¯·æ£€æŸ¥[codepen](https://codepen.io/pomber/pen/eWbwBq?editors=0010)ã€‚ä½ ä¹Ÿå¯ä»¥ä»[githubå›è´­ä¸­æ£€æŸ¥è¿™ä¸ªå·®å¼‚](https://github.com/hexacta/didact/commit/fc4d360d91a1e68f0442d39dbce5b9cca5a08f24)ã€‚

---

ä¸‹ä¸€ç¯‡æ–‡ç« ï¼š[Didact: Element creation and JSX {en}](https://engineering.hexacta.com/didact-element-creation-and-jsx-d05171c55c56) |-|_|ğŸŒŸ|[Didactï¼šå…ƒç´ åˆ›å»ºå’ŒJSX {zh}](#2-%E5%85%83%E7%B4%A0%E5%88%9B%E5%BB%BA%E5%92%8Cjsx)
